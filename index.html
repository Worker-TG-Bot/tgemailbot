<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot - Cloudflare Worker éƒ¨ç½²æŒ‡å—</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .code-container {
      max-height: 600px;
      overflow-y: auto;
    }
    pre[class*="language-"] {
      margin: 0;
      border-radius: 0.5rem;
    }
    .step-number {
      width: 32px;
      height: 32px;
      min-width: 32px;
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg py-12 px-4">
    <div class="max-w-5xl mx-auto text-center">
      <div class="flex items-center justify-center gap-4 mb-4">
        <span class="text-5xl">ğŸ“§</span>
        <span class="text-5xl">ğŸ¤–</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Gmail Telegram Bot</h1>
      <p class="text-xl text-purple-100 max-w-2xl mx-auto">
        åŸºäº Cloudflare Workers çš„ Telegram Botï¼Œå®‰å…¨è®¿é—® Gmail é‚®ç®±ï¼Œæ”¯æŒå®æ—¶æ¨é€
      </p>
      <div class="flex flex-wrap justify-center gap-3 mt-6">
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âœ¨ å®Œå…¨å…è´¹</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”’ OAuth å®‰å…¨è®¤è¯</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”” å®æ—¶æ¨é€</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ‘¥ å¤šè´¦æˆ·æ”¯æŒ</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸŒ ç½‘é¡µé¢„è§ˆé‚®ä»¶</span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-12">
    <!-- Features -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸš€</span> åŠŸèƒ½ç‰¹æ€§
      </h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ‘¥</div>
          <h3 class="font-semibold mb-1">å¤šè´¦æˆ·ç®¡ç†</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒç»‘å®šå¤šä¸ª Gmail è´¦å·ï¼Œä¸€é”®åˆ‡æ¢</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ””</div>
          <h3 class="font-semibold mb-1">å®æ—¶æ¨é€</h3>
          <p class="text-gray-400 text-sm">é€šè¿‡ Pub/Sub å®ç°æ–°é‚®ä»¶å®æ—¶é€šçŸ¥</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“¬</div>
          <h3 class="font-semibold mb-1">åˆ†é¡µæµè§ˆé‚®ä»¶</h3>
          <p class="text-gray-400 text-sm">ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µï¼Œæ¯é¡µ5å°é‚®ä»¶</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸŒ</div>
          <h3 class="font-semibold mb-1">ç½‘é¡µé¢„è§ˆ</h3>
          <p class="text-gray-400 text-sm">å®Œæ•´ HTML æ¸²æŸ“ï¼Œä¸´æ—¶å®‰å…¨é“¾æ¥</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">æ™ºèƒ½æœç´¢</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒ Gmail æœç´¢è¯­æ³•ï¼Œå¿«æ·æŒ‰é’®</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“Š</div>
          <h3 class="font-semibold mb-1">é‚®ç®±ç»Ÿè®¡</h3>
          <p class="text-gray-400 text-sm">æœªè¯»æ•°ã€ä»Šæ—¥é‚®ä»¶ã€æ˜Ÿæ ‡æ•°é‡ç»Ÿè®¡</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“</div>
          <h3 class="font-semibold mb-1">é™„ä»¶ä¸‹è½½</h3>
          <p class="text-gray-400 text-sm">ç›´æ¥ä¸‹è½½é™„ä»¶åˆ° Telegramï¼ˆâ‰¤20MBï¼‰</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">âœ…</div>
          <h3 class="font-semibold mb-1">æ‰¹é‡æ“ä½œ</h3>
          <p class="text-gray-400 text-sm">ä¸€é”®å…¨éƒ¨å·²è¯»ã€å•å°æ ‡è®°ã€åˆ é™¤</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">å®‰å…¨è®¤è¯</h3>
          <p class="text-gray-400 text-sm">Google OAuth 2.0ï¼Œæ— éœ€æä¾›å¯†ç </p>
        </div>
      </div>
    </section>

    <!-- Button Menu -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âŒ¨ï¸</span> å¿«æ·æŒ‰é’®èœå•
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <p class="text-gray-300 mb-4">Bot ä½¿ç”¨è¾“å…¥æ¡†ä¸‹æ–¹çš„å¿«æ·æŒ‰é’®ï¼Œæ— éœ€è¾“å…¥å‘½ä»¤ï¼š</p>
        <div class="bg-gray-900 rounded-lg p-4 max-w-md mx-auto">
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">ğŸ“¬ æ”¶ä»¶ç®±</div>
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">ğŸ“… ä»Šæ—¥</div>
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">â­ æ˜Ÿæ ‡</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">ğŸ” æœç´¢</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">ğŸ“Š ç»Ÿè®¡</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">âœ… å…¨å·²è¯»</div>
            <div class="bg-purple-600/30 border border-purple-500/50 rounded py-2 col-span-2">ğŸ‘¤ è´¦æˆ·ç®¡ç†</div>
            <div class="bg-purple-600/30 border border-purple-500/50 rounded py-2">âš™ï¸ è®¾ç½®</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Deployment Steps -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ“‹</span> éƒ¨ç½²æ­¥éª¤
      </h2>
      
      <div class="space-y-6">
        <!-- Step 1 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Telegram Bot</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æœç´¢ <code class="bg-gray-700 px-2 py-0.5 rounded">@BotFather</code></li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/newbot</code> åˆ›å»ºæ–° Bot</li>
                <li>æŒ‰æç¤ºè®¾ç½®åç§°ï¼Œè·å– <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">BOT_TOKEN</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Google OAuth å‡­è¯</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è®¿é—® <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-purple-400 hover:underline">Google Cloud Console</a></li>
                <li>åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚å·²æœ‰å¯è·³è¿‡ï¼‰</li>
                <li>åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼ˆé€‰æ‹© Web åº”ç”¨ç±»å‹ï¼‰</li>
                <li>æ·»åŠ æˆæƒé‡å®šå‘ URIï¼š
                  <code class="block bg-gray-700 px-3 py-2 rounded mt-1 text-sm break-all">https://your-worker.your-username.workers.dev/oauth/callback</code>
                </li>
                <li>å¯ç”¨ <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" class="text-purple-400 hover:underline">Gmail API</a></li>
                <li>è®°å½• <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_ID</code> å’Œ <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_SECRET</code></li>
              </ol>
              <div class="mt-3 p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-yellow-200 text-sm">
                âš ï¸ æ³¨æ„ï¼šå¦‚æœåº”ç”¨æœªå‘å¸ƒï¼Œéœ€åœ¨ OAuth åŒæ„å±å¹•æ·»åŠ æµ‹è¯•ç”¨æˆ·ï¼ˆä½ çš„ Gmail åœ°å€ï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Cloudflare Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>ç™»å½• <a href="https://dash.cloudflare.com" target="_blank" class="text-purple-400 hover:underline">Cloudflare Dashboard</a></li>
                <li>è¿›å…¥ Workers & Pages â†’ Create application â†’ Create Worker</li>
                <li>ç»™ Worker èµ·åï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-bot</code>ï¼‰</li>
                <li>ç‚¹å‡» Deploy åˆ›å»º</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">4</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º KV Namespace</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>Workers & Pages â†’ KV â†’ Create namespace</li>
                <li>åç§°å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
                <li>è¿›å…¥ Worker Settings â†’ Variables â†’ KV Namespace Bindings</li>
                <li>Add bindingï¼šVariable name å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">5</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">è®¾ç½®ç¯å¢ƒå˜é‡</h3>
              <p class="text-gray-300 mb-3">åœ¨ Worker Settings â†’ Variables â†’ Environment Variables æ·»åŠ ï¼š</p>
              <div class="bg-gray-900 rounded-lg p-4 space-y-2 font-mono text-sm">
                <div><span class="text-purple-400">BOT_TOKEN</span> = <span class="text-gray-400">ä½ çš„ Telegram Bot Token</span></div>
                <div><span class="text-purple-400">BOT_SECRET</span> = <span class="text-gray-400">è‡ªå®šä¹‰å¯†ç ï¼ˆå¦‚ mysecret123ï¼‰</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_ID</span> = <span class="text-gray-400">OAuth Client ID</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_SECRET</span> = <span class="text-gray-400">OAuth Client Secret</span></div>
                <div><span class="text-green-400">PUBSUB_TOPIC</span> = <span class="text-gray-400">ï¼ˆå¯é€‰ï¼‰projects/é¡¹ç›®ID/topics/ä¸»é¢˜å</span></div>
              </div>
              <div class="mt-3 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                ğŸ’¡ å»ºè®®å°† GOOGLE_CLIENT_SECRET è®¾ä¸ºåŠ å¯†å˜é‡ï¼ˆEncryptï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">6</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">å¤åˆ¶ä»£ç åˆ° Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Worker é¡µé¢ç‚¹å‡» "Edit code" æˆ– "Quick edit"</li>
                <li>åˆ é™¤é»˜è®¤ä»£ç </li>
                <li>å¤åˆ¶ä¸‹æ–¹å®Œæ•´ä»£ç ç²˜è´´</li>
                <li>ç‚¹å‡» Save and Deploy</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 7 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">7</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">ä¸€é”®è®¾ç½® Webhook</h3>
              <p class="text-gray-300 mb-2">æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€å®Œæˆè®¾ç½®ï¼š</p>
              <code class="block bg-gray-700 px-3 py-2 rounded text-sm break-all">
                https://your-worker.workers.dev/setup?secret=ä½ çš„BOT_SECRET
              </code>
              <p class="text-gray-400 text-sm mt-2">çœ‹åˆ° "âœ… è®¾ç½®æˆåŠŸ" å³å®Œæˆ</p>
            </div>
          </div>
        </div>

        <!-- Step 8 (Optional) -->
        <div class="bg-gray-800 rounded-xl p-6 border border-orange-700/50">
          <div class="flex gap-4">
            <div class="step-number bg-orange-600 rounded-full flex items-center justify-center font-bold shrink-0 text-sm">é€‰</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-orange-400">é…ç½®å®æ—¶æ¨é€ï¼ˆå¯é€‰ï¼‰</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è¿›å…¥ <a href="https://console.cloud.google.com/cloudpubsub/topic" target="_blank" class="text-purple-400 hover:underline">Google Cloud Pub/Sub</a></li>
                <li>åˆ›å»º Topicï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-notifications</code>ï¼‰</li>
                <li>ç»™ Topic æ·»åŠ æƒé™ï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">gmail-api-push@system.gserviceaccount.com</code> â†’ Pub/Sub Publisher</li>
                <li>åˆ›å»º Push Subscriptionï¼Œç«¯ç‚¹ï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">https://your-worker.workers.dev/pubsub/push?secret=BOT_SECRET</code></li>
                <li>æ·»åŠ ç¯å¢ƒå˜é‡ <code class="bg-gray-700 px-2 py-0.5 rounded">PUBSUB_TOPIC</code></li>
                <li>è®¾ç½® Cron Triggerï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">0 0 * * *</code>ï¼ˆæ¯å¤©è‡ªåŠ¨ç»­æœŸ watchï¼‰</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Done -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-green-500/50">
          <div class="flex gap-4">
            <div class="step-number bg-green-600 rounded-full flex items-center justify-center font-bold shrink-0">âœ“</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-green-400">å¼€å§‹ä½¿ç”¨ï¼</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æ‰¾åˆ°ä½ çš„ Bot</li>
                <li>å‘é€ä»»æ„æ¶ˆæ¯æˆ–ç‚¹å‡» <code class="bg-gray-700 px-2 py-0.5 rounded">å¼€å§‹</code></li>
                <li>ä½¿ç”¨åº•éƒ¨æŒ‰é’®èœå•æ“ä½œ</li>
                <li>ç‚¹å‡» <code class="bg-gray-700 px-2 py-0.5 rounded">ğŸ‘¤ è´¦æˆ·ç®¡ç†</code> â†’ <code class="bg-gray-700 px-2 py-0.5 rounded">â• æ·»åŠ è´¦æˆ·</code> ç»‘å®š Gmail</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Complete Code -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <span class="text-purple-400">ğŸ“„</span> å®Œæ•´ Worker ä»£ç 
        </h2>
        <button id="copyBtn" class="copy-btn bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
          <span id="copyIcon">ğŸ“‹</span>
          <span id="copyText">å¤åˆ¶ä»£ç </span>
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <div class="bg-gray-700/50 px-4 py-2 flex items-center gap-2 border-b border-gray-700">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-2 text-gray-400 text-sm font-mono">worker.js</span>
        </div>
        <div class="code-container">
          <pre><code class="language-javascript" id="workerCode"></code></pre>
        </div>
      </div>
    </section>

    <!-- Environment Variables -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âš™ï¸</span> ç¯å¢ƒå˜é‡è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å˜é‡å</th>
              <th class="text-left px-5 py-3 font-semibold">å¿…éœ€</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_TOKEN</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Telegram Bot Token</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_SECRET</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Webhook ä¿æŠ¤å¯†ç </td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_ID</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Client ID</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_SECRET</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Secret (å»ºè®®åŠ å¯†)</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-green-400">PUBSUB_TOPIC</td>
              <td class="px-5 py-3">â­•</td>
              <td class="px-5 py-3 text-gray-300">Pub/Sub ä¸»é¢˜ï¼ˆå®æ—¶æ¨é€éœ€è¦ï¼‰</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ”§</span> å¸¸è§é—®é¢˜
      </h2>
      <div class="space-y-4">
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æˆæƒæ—¶æç¤º "Access blocked" æˆ– "æœªç»éªŒè¯çš„åº”ç”¨"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>è¿™æ˜¯å› ä¸º Google åº”ç”¨æœªå‘å¸ƒã€‚è§£å†³æ–¹æ³•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>è¿›å…¥ Google Cloud Console â†’ OAuth åŒæ„å±å¹•</li>
              <li>åœ¨"æµ‹è¯•ç”¨æˆ·"ä¸­æ·»åŠ ä½ çš„ Gmail åœ°å€</li>
              <li>æˆ–è€…å‘å¸ƒåº”ç”¨ï¼ˆéœ€è¦éªŒè¯ï¼‰</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æç¤º "redirect_uri_mismatch"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é‡å®šå‘ URI ä¸åŒ¹é…ã€‚ç¡®ä¿ Google Console ä¸­çš„æˆæƒé‡å®šå‘ URI å®Œå…¨åŒ¹é…ï¼š</p>
            <code class="block bg-gray-700 px-3 py-2 rounded mt-2 text-sm">https://your-worker.workers.dev/oauth/callback</code>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Bot æ²¡æœ‰å“åº”</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²è®¿é—® <code class="bg-gray-700 px-2 py-0.5 rounded">/setup?secret=xxx</code> è®¾ç½® Webhook</li>
              <li>æ£€æŸ¥ Worker æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯</li>
              <li>ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</li>
              <li>ç¡®è®¤ KV Namespace å·²ç»‘å®š</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">åº•éƒ¨æŒ‰é’®ä¸æ˜¾ç¤º</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>ReplyKeyboard æŒ‰é’®éœ€è¦ Bot å‘é€ä¸€æ¬¡æ¶ˆæ¯åæ‰ä¼šæ˜¾ç¤ºã€‚å°è¯•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>å‘ Bot å‘é€ä»»æ„æ¶ˆæ¯</li>
              <li>æˆ–å‘é€ /start å‘½ä»¤</li>
              <li>æŒ‰é’®ä¼šå‡ºç°åœ¨è¾“å…¥æ¡†ä¸Šæ–¹</li>
            </ol>
          </div>
        </details>

        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æ¨é€åŠŸèƒ½ä¸å·¥ä½œ</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²åˆ›å»º Pub/Sub Topic å¹¶é…ç½® PUBSUB_TOPIC å˜é‡</li>
              <li>ç¡®è®¤ Push Subscription ç«¯ç‚¹æ­£ç¡®</li>
              <li>ç¡®è®¤ gmail-api-push@system.gserviceaccount.com æœ‰å‘å¸ƒæƒé™</li>
              <li>åœ¨ Bot ä¸­ç‚¹å‡» âš™ï¸ è®¾ç½® â†’ ğŸ”” å¼€å¯æ¨é€</li>
              <li>è®¾ç½® Cron Trigger æ¯å¤©ç»­æœŸ watch</li>
            </ol>
          </div>
        </details>

        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">ç½‘é¡µé¢„è§ˆé“¾æ¥æ‰“ä¸å¼€</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>é“¾æ¥æœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼Œè¿‡æœŸåéœ€é‡æ–°ç”Ÿæˆ</li>
              <li>é“¾æ¥åŒ…å«å®‰å…¨ tokenï¼Œä»…æˆæƒç”¨æˆ·å¯è®¿é—®</li>
              <li>ç¡®ä¿ç½‘ç»œå¯ä»¥è®¿é—® Cloudflare Workers</li>
            </ol>
          </div>
        </details>
      </div>
    </section>

    <!-- Architecture -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ—ï¸</span> æ¶æ„è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <div class="flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“±</div>
            <div class="text-sm">Telegram</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Cloudflare Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-red-600/20 border border-red-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“§</div>
            <div class="text-sm">Gmail API</div>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-green-600/20 border border-green-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“¡</div>
            <div class="text-sm">Pub/Sub</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ””</div>
            <div class="text-sm">æ¨é€é€šçŸ¥</div>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-cyan-600/20 border border-cyan-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸŒ</div>
            <div class="text-sm">ç½‘é¡µé¢„è§ˆ</div>
          </div>
          <div class="text-gray-500">â†</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Worker /mail/token</div>
          </div>
          <div class="text-gray-500">â†</div>
          <div class="bg-purple-600/20 border border-purple-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ”—</div>
            <div class="text-sm">ä¸´æ—¶å®‰å…¨é“¾æ¥</div>
          </div>
        </div>
        <div class="mt-6 grid md:grid-cols-3 gap-4 text-center text-sm">
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">KV Storage</div>
            <div class="text-gray-400">å­˜å‚¨ Tokenã€é‚®ä»¶ç¼“å­˜</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">å¤šè´¦æˆ·</div>
            <div class="text-gray-400">æ¯ç”¨æˆ·æ”¯æŒå¤šä¸ª Gmail</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">ä¸´æ—¶é“¾æ¥</div>
            <div class="text-gray-400">1å°æ—¶æœ‰æ•ˆï¼Œå®‰å…¨åŠ å¯†</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800/50 border-t border-gray-700 py-8 px-4">
    <div class="max-w-5xl mx-auto text-center text-gray-400">
      <p>Gmail Telegram Bot - åŸºäº Cloudflare Workers</p>
      <p class="mt-2 text-sm">å®Œå…¨å…è´¹ Â· å¤šè´¦æˆ·æ”¯æŒ Â· å®æ—¶æ¨é€ Â· ç½‘é¡µé¢„è§ˆ Â· å®‰å…¨å¯é </p>
    </div>
  </footer>

  <script>
    // Worker å®Œæ•´ä»£ç  (v2.2 - ç»Ÿä¸€æ—¶é—´å‡½æ•°ç‰ˆ)
    const workerCode = `/**
 * Gmail Telegram Bot - Cloudflare Worker (v2.2)
 * åŠŸèƒ½ï¼šé€šè¿‡ Telegram Bot å®‰å…¨è®¿é—® Gmail é‚®ç®±
 * ç‰¹æ€§ï¼šå¤šè´¦æˆ·ã€åˆ†é¡µæµè§ˆã€å®æ—¶æ¨é€ã€ç½‘é¡µé¢„è§ˆã€æ‰¹é‡æ“ä½œ
 */

const GMAIL_SCOPES = [
  'https://www.googleapis.com/auth/gmail.readonly',
  'https://www.googleapis.com/auth/gmail.modify'
].join(' ');

const PAGE_SIZE = 5;
const MAX_CONTENT_LENGTH = 3500;
const PREVIEW_LENGTH = 300;

// ==================== ä¸»å…¥å£ ====================
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    try {
      // è®¾ç½® webhook
      if (path === '/setup') {
        return await handleSetup(url, env);
      }
      
      // OAuth å›è°ƒ
      if (path === '/oauth/callback') {
        return await handleOAuthCallback(request, env);
      }
      
      // é‚®ä»¶ç½‘é¡µé¢„è§ˆ
      if (path.startsWith('/mail/')) {
        return await handleMailView(path, env);
      }
      
      // Pub/Sub æ¨é€
      if (path === '/pubsub/push') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return new Response('Unauthorized', { status: 401 });
        }
        const message = await request.json();
        ctx.waitUntil(handlePubSubPush(message, env));
        return new Response('OK');
      }
      
      // Telegram webhook
      if (path === '/webhook' && request.method === 'POST') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return new Response('Unauthorized', { status: 401 });
        }
        const update = await request.json();
        ctx.waitUntil(handleTelegramUpdate(update, env, url.origin));
        return new Response('OK');
      }

      return new Response(getHomePage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    } catch (error) {
      console.error('Error:', error);
      return new Response('Error: ' + error.message, { status: 500 });
    }
  },

  async scheduled(event, env, ctx) {
    ctx.waitUntil(renewAllWatches(env));
  }
};

// ==================== ç»Ÿä¸€æ—¶é—´å‡½æ•° ====================
function toBeijingTime(date) {
  const d = typeof date === 'string' ? new Date(date) : date;
  return new Date(d.getTime() + 8 * 60 * 60 * 1000);
}

function formatDate(dateStr, format = 'short') {
  try {
    const d = toBeijingTime(dateStr);
    const year = d.getUTCFullYear();
    const month = d.getUTCMonth() + 1;
    const day = d.getUTCDate();
    const hours = String(d.getUTCHours()).padStart(2, '0');
    const minutes = String(d.getUTCMinutes()).padStart(2, '0');
    const seconds = String(d.getUTCSeconds()).padStart(2, '0');
    
    switch (format) {
      case 'chinese':
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[d.getUTCDay()];
        return \`\${year}å¹´\${month}æœˆ\${day}æ—¥ æ˜ŸæœŸ\${weekday} \${hours}:\${minutes} (åŒ—äº¬æ—¶é—´)\`;
      case 'full':
        return \`\${year}/\${month}/\${day} \${hours}:\${minutes}:\${seconds}\`;
      case 'short':
      default:
        return \`\${month}/\${day} \${hours}:\${minutes}\`;
    }
  } catch {
    return dateStr;
  }
}

function getTodayTimestamp() {
  const now = Date.now();
  const offset = 8 * 60 * 60 * 1000;
  const beijingMs = now + offset;
  const dayMs = 24 * 60 * 60 * 1000;
  const beijingMidnight = beijingMs - (beijingMs % dayMs);
  return Math.floor((beijingMidnight - offset) / 1000);
}

// ==================== Telegram API ====================
async function sendTelegram(token, method, data) {
  const resp = await fetch(\`https://api.telegram.org/bot\${token}/\${method}\`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return resp.json();
}

function getMainKeyboard() {
  return {
    keyboard: [
      [{ text: 'ğŸ“¬ æ”¶ä»¶ç®±' }, { text: 'ğŸ“… ä»Šæ—¥' }, { text: 'â­ æ˜Ÿæ ‡' }],
      [{ text: 'ğŸ” æœç´¢' }, { text: 'ğŸ“Š ç»Ÿè®¡' }, { text: 'âœ… å…¨å·²è¯»' }],
      [{ text: 'ğŸ‘¤ è´¦æˆ·ç®¡ç†' }, { text: 'âš™ï¸ è®¾ç½®' }]
    ],
    resize_keyboard: true,
    persistent: true
  };
}

// ==================== Token ç®¡ç† ====================
async function getActiveAccount(userId, env) {
  const email = await env.USER_TOKENS.get(\`active:\${userId}\`);
  if (!email) return null;
  
  const tokenRaw = await env.USER_TOKENS.get(\`token:\${userId}:\${email}\`);
  if (!tokenRaw) return null;
  
  try {
    const token = JSON.parse(tokenRaw);
    token.email = email;
    
    if (Date.now() > token.expiry - 60000) {
      const refreshed = await refreshToken(token.refresh_token, env);
      if (refreshed) {
        token.access_token = refreshed.access_token;
        token.expiry = Date.now() + refreshed.expires_in * 1000;
        await env.USER_TOKENS.put(\`token:\${userId}:\${email}\`, JSON.stringify(token));
      } else {
        return null;
      }
    }
    
    return token;
  } catch {
    return null;
  }
}

async function refreshToken(refreshToken, env) {
  const resp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: env.GOOGLE_CLIENT_ID,
      client_secret: env.GOOGLE_CLIENT_SECRET,
      refresh_token: refreshToken,
      grant_type: 'refresh_token'
    })
  });
  const data = await resp.json();
  return data.access_token ? data : null;
}

async function getAccountList(userId, env) {
  const raw = await env.USER_TOKENS.get(\`accounts:\${userId}\`);
  try {
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}

// ==================== é‚®ä»¶IDæ˜ å°„ ====================
async function storeMailIds(userId, mails, env) {
  const mapping = {};
  mails.forEach((mail, index) => {
    mapping[index] = mail.id;
  });
  await env.USER_TOKENS.put(\`mailmap:\${userId}\`, JSON.stringify(mapping), { expirationTtl: 3600 });
  return mapping;
}

async function getMailId(userId, index, env) {
  const raw = await env.USER_TOKENS.get(\`mailmap:\${userId}\`);
  if (!raw) return null;
  try {
    const mapping = JSON.parse(raw);
    return mapping[index] || null;
  } catch {
    return null;
  }
}

// ==================== Setup ====================
async function handleSetup(url, env) {
  const secret = url.searchParams.get('secret');
  if (secret !== env.BOT_SECRET) {
    return new Response('Unauthorized', { status: 401 });
  }

  const webhookUrl = \`\${url.origin}/webhook?secret=\${env.BOT_SECRET}\`;
  await sendTelegram(env.BOT_TOKEN, 'setWebhook', { url: webhookUrl });
  await sendTelegram(env.BOT_TOKEN, 'deleteMyCommands', {});

  return new Response(\`âœ… è®¾ç½®å®Œæˆï¼Webhook: \${webhookUrl}\`);
}

// ==================== OAuth ====================
async function handleOAuthCallback(request, env) {
  const url = new URL(request.url);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');

  if (error) {
    return new Response(getResultPage(false, error), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  if (!code || !state) {
    return new Response(getResultPage(false, 'å‚æ•°ç¼ºå¤±'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  let stateData;
  try {
    stateData = JSON.parse(atob(state));
  } catch {
    return new Response(getResultPage(false, 'State æ— æ•ˆ'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const { userId, nonce } = stateData;
  const storedNonce = await env.USER_TOKENS.get(\`nonce:\${userId}\`);
  
  if (!storedNonce || storedNonce !== nonce) {
    return new Response(getResultPage(false, 'æˆæƒå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const tokenResp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      code,
      client_id: env.GOOGLE_CLIENT_ID,
      client_secret: env.GOOGLE_CLIENT_SECRET,
      redirect_uri: \`\${url.origin}/oauth/callback\`,
      grant_type: 'authorization_code'
    })
  });
  
  const tokenData = await tokenResp.json();
  
  if (!tokenData.access_token) {
    return new Response(getResultPage(false, tokenData.error_description || tokenData.error), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const profileResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {
    headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
  });
  const profile = await profileResp.json();
  const email = profile.emailAddress;

  await env.USER_TOKENS.put(\`token:\${userId}:\${email}\`, JSON.stringify({
    access_token: tokenData.access_token,
    refresh_token: tokenData.refresh_token,
    expiry: Date.now() + tokenData.expires_in * 1000
  }));

  const accounts = await getAccountList(userId, env);
  if (!accounts.includes(email)) {
    accounts.push(email);
    await env.USER_TOKENS.put(\`accounts:\${userId}\`, JSON.stringify(accounts));
  }

  await env.USER_TOKENS.put(\`active:\${userId}\`, email);
  await env.USER_TOKENS.delete(\`nonce:\${userId}\`);

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: userId,
    text: \`âœ… è´¦æˆ·ç»‘å®šæˆåŠŸï¼\\n\\nğŸ“§ \${email}\\n\\nç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä½¿ç”¨\`,
    reply_markup: getMainKeyboard()
  });

  return new Response(getResultPage(true, email), {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

// ==================== é‚®ä»¶ç½‘é¡µé¢„è§ˆ ====================
async function handleMailView(path, env) {
  const token = path.replace('/mail/', '');
  const mailData = await env.USER_TOKENS.get(\`view:\${token}\`);
  
  if (!mailData) {
    return new Response(getExpiredPage(), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' },
      status: 404
    });
  }

  try {
    const { userId, mailId, email } = JSON.parse(mailData);
    
    const tokenRaw = await env.USER_TOKENS.get(\`token:\${userId}:\${email}\`);
    if (!tokenRaw) {
      return new Response(getExpiredPage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
        status: 401
      });
    }

    let tokenInfo = JSON.parse(tokenRaw);
    
    if (Date.now() > tokenInfo.expiry - 60000) {
      const refreshed = await refreshToken(tokenInfo.refresh_token, env);
      if (refreshed) {
        tokenInfo.access_token = refreshed.access_token;
        tokenInfo.expiry = Date.now() + refreshed.expires_in * 1000;
        await env.USER_TOKENS.put(\`token:\${userId}:\${email}\`, JSON.stringify(tokenInfo));
      } else {
        return new Response(getExpiredPage(), {
          headers: { 'Content-Type': 'text/html; charset=utf-8' },
          status: 401
        });
      }
    }

    const resp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
      { headers: { Authorization: \`Bearer \${tokenInfo.access_token}\` } }
    );

    if (!resp.ok) {
      return new Response(getExpiredPage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
        status: 404
      });
    }

    const mail = await resp.json();
    return new Response(renderMailPage(mail), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });

  } catch (e) {
    return new Response(getExpiredPage(), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' },
      status: 500
    });
  }
}

function renderMailPage(mail) {
  const headers = mail.payload?.headers || [];
  const getHeader = (n) => headers.find(h => h.name.toLowerCase() === n.toLowerCase())?.value || '';
  
  const from = getHeader('From');
  const to = getHeader('To');
  const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';
  const date = formatDate(getHeader('Date'), 'chinese');

  let htmlContent = findBody(mail.payload, 'text/html');
  let textContent = findBody(mail.payload, 'text/plain');
  
  let body = '';
  if (htmlContent) {
    try {
      const base64 = htmlContent.replace(/-/g, '+').replace(/_/g, '/');
      body = decodeBase64(base64);
    } catch {
      body = '<p>æ— æ³•è§£æé‚®ä»¶å†…å®¹</p>';
    }
  } else if (textContent) {
    try {
      const base64 = textContent.replace(/-/g, '+').replace(/_/g, '/');
      const text = decodeBase64(base64);
      body = '<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;">' + 
             text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
    } catch {
      body = '<p>æ— æ³•è§£æé‚®ä»¶å†…å®¹</p>';
    }
  } else {
    body = '<p>æ— é‚®ä»¶å†…å®¹</p>';
  }

  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>\${subject.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .header h1 { font-size: 18px; font-weight: 600; margin-bottom: 12px; word-break: break-word; }
    .meta { font-size: 13px; opacity: 0.9; }
    .meta-row { margin: 4px 0; display: flex; }
    .meta-label { width: 50px; opacity: 0.7; }
    .meta-value { flex: 1; word-break: break-all; }
    .content { background: white; margin: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .content-inner { padding: 20px; overflow-x: auto; }
    .content-inner img { max-width: 100%; height: auto; }
    .content-inner a { color: #667eea; }
    .content-inner table { max-width: 100%; }
    .footer { text-align: center; padding: 20px; color: #999; font-size: 12px; }
    .back-btn { display: inline-block; margin-top: 10px; padding: 8px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 20px; font-size: 14px; }
    @media (max-width: 600px) {
      .header { padding: 16px; }
      .header h1 { font-size: 16px; }
      .content { margin: 12px; }
      .content-inner { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>\${subject.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h1>
    <div class="meta">
      <div class="meta-row"><span class="meta-label">å‘ä»¶äºº</span><span class="meta-value">\${from.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span></div>
      <div class="meta-row"><span class="meta-label">æ”¶ä»¶äºº</span><span class="meta-value">\${to.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span></div>
      <div class="meta-row"><span class="meta-label">æ—¶é—´</span><span class="meta-value">\${date}</span></div>
    </div>
  </div>
  <div class="content">
    <div class="content-inner">\${body}</div>
  </div>
  <div class="footer">
    <p>æ­¤é“¾æ¥ 1 å°æ—¶å†…æœ‰æ•ˆ</p>
    <a href="https://t.me" class="back-btn">è¿”å› Telegram</a>
  </div>
</body>
</html>\`;
}

function getExpiredPage() {
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é“¾æ¥å·²è¿‡æœŸ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
    .box { text-align: center; padding: 40px; }
    .icon { font-size: 64px; margin-bottom: 20px; }
    h1 { margin-bottom: 10px; }
    p { opacity: 0.7; margin-bottom: 20px; }
    .btn { display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 25px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="box">
    <div class="icon">â°</div>
    <h1>é“¾æ¥å·²è¿‡æœŸ</h1>
    <p>æ­¤é‚®ä»¶é¢„è§ˆé“¾æ¥å·²å¤±æ•ˆï¼Œè¯·è¿”å› Telegram é‡æ–°ç”Ÿæˆ</p>
    <a href="https://t.me" class="btn">è¿”å› Telegram</a>
  </div>
</body>
</html>\`;
}

function decodeBase64(base64) {
  const binary = atob(base64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  return new TextDecoder('utf-8').decode(bytes);
}

// ==================== ç”Ÿæˆé¢„è§ˆé“¾æ¥ ====================
async function generateViewLink(userId, mailId, email, env) {
  const origin = await env.USER_TOKENS.get('origin');
  const token = crypto.randomUUID();
  
  await env.USER_TOKENS.put(\`view:\${token}\`, JSON.stringify({
    userId,
    mailId,
    email
  }), { expirationTtl: 3600 });
  
  return \`\${origin}/mail/\${token}\`;
}

// ==================== Telegram æ›´æ–°å¤„ç† ====================
async function handleTelegramUpdate(update, env, origin) {
  await env.USER_TOKENS.put('origin', origin);

  if (update.callback_query) {
    await handleCallback(update.callback_query, env);
  } else if (update.message?.text) {
    await handleMessage(update.message, env);
  }
}

async function handleMessage(message, env) {
  const chatId = message.chat.id;
  const userId = String(message.from.id);
  const text = message.text.trim();

  const todayTs = getTodayTimestamp();

  const handlers = {
    '/start': () => sendWelcome(chatId, userId, env),
    'ğŸ  ä¸»èœå•': () => sendWelcome(chatId, userId, env),
    'ğŸ“¬ æ”¶ä»¶ç®±': () => sendMailList(chatId, userId, 'in:inbox', null, null, env),
    'ğŸ“… ä»Šæ—¥': () => sendMailList(chatId, userId, \`after:\${todayTs}\`, null, null, env),
    'â­ æ˜Ÿæ ‡': () => sendMailList(chatId, userId, 'is:starred', null, null, env),
    'ğŸ” æœç´¢': () => sendSearchHelp(chatId, env),
    'ğŸ“Š ç»Ÿè®¡': () => sendStats(chatId, userId, null, env),
    'âœ… å…¨å·²è¯»': () => markAllRead(chatId, userId, env),
    'ğŸ‘¤ è´¦æˆ·ç®¡ç†': () => sendAccountManager(chatId, userId, null, env),
    'âš™ï¸ è®¾ç½®': () => sendSettings(chatId, userId, env)
  };

  if (handlers[text]) {
    await handlers[text]();
    return;
  }

  if (text.startsWith('æœç´¢ ') || text.startsWith('/search ')) {
    const query = text.replace(/^(æœç´¢ |\\/search )/, '').trim();
    if (query) {
      await sendMailList(chatId, userId, query, null, null, env);
    }
    return;
  }

  await sendWelcome(chatId, userId, env);
}

// ==================== æ¬¢è¿æ¶ˆæ¯ ====================
async function sendWelcome(chatId, userId, env) {
  const accounts = await getAccountList(userId, env);
  const active = await env.USER_TOKENS.get(\`active:\${userId}\`);
  
  let text = 'ğŸ“§ *Gmail Telegram Bot*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
  
  if (accounts.length > 0) {
    text += \`ğŸ‘¤ å½“å‰è´¦æˆ·: \${active || 'æœªé€‰æ‹©'}\\nğŸ“Š å·²ç»‘å®š \${accounts.length} ä¸ªè´¦æˆ·\\n\\n\`;
    text += 'ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ“ä½œ ğŸ‘‡';
  } else {
    text += 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼\\n\\nè¯·ç‚¹å‡» *ğŸ‘¤ è´¦æˆ·ç®¡ç†* æ·»åŠ  Gmail è´¦æˆ·';
  }

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: getMainKeyboard()
  });
}

// ==================== é‚®ä»¶åˆ—è¡¨ ====================
async function sendMailList(chatId, userId, query, pageToken, editMsgId, env) {
  const account = await getActiveAccount(userId, env);
  
  if (!account) {
    const method = editMsgId ? 'editMessageText' : 'sendMessage';
    const params = {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®šè´¦æˆ·\\n\\nç‚¹å‡» *ğŸ‘¤ è´¦æˆ·ç®¡ç†* æ·»åŠ  Gmail',
      parse_mode: 'Markdown'
    };
    if (editMsgId) params.message_id = editMsgId;
    else params.reply_markup = getMainKeyboard();
    await sendTelegram(env.BOT_TOKEN, method, params);
    return;
  }

  await env.USER_TOKENS.put(\`lastquery:\${userId}\`, query, { expirationTtl: 3600 });

  const listUrl = new URL('https://gmail.googleapis.com/gmail/v1/users/me/messages');
  listUrl.searchParams.set('maxResults', PAGE_SIZE);
  listUrl.searchParams.set('q', query);
  if (pageToken) listUrl.searchParams.set('pageToken', pageToken);

  const listResp = await fetch(listUrl, {
    headers: { Authorization: \`Bearer \${account.access_token}\` }
  });
  const listData = await listResp.json();

  if (!listData.messages?.length) {
    const method = editMsgId ? 'editMessageText' : 'sendMessage';
    const params = {
      chat_id: chatId,
      text: \`ğŸ“­ \${query}\\n\\næ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é‚®ä»¶\`,
      reply_markup: {
        inline_keyboard: [[{ text: 'ğŸ”„ åˆ·æ–°', callback_data: \`ref:\${query.substring(0, 50)}\` }]]
      }
    };
    if (editMsgId) params.message_id = editMsgId;
    await sendTelegram(env.BOT_TOKEN, method, params);
    return;
  }

  const mails = [];
  for (const msg of listData.messages) {
    const detailResp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${msg.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date\`,
      { headers: { Authorization: \`Bearer \${account.access_token}\` } }
    );
    const detail = await detailResp.json();
    const headers = detail.payload?.headers || [];
    const getHeader = (n) => headers.find(h => h.name.toLowerCase() === n.toLowerCase())?.value || '';
    
    let from = getHeader('From');
    const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.[a-z]+/i);
    if (emailMatch) {
      from = from.replace(emailMatch[0], '').replace(/[<>"]/g, '').trim() || emailMatch[0];
    }
    
    mails.push({
      id: msg.id,
      from: from.substring(0, 20),
      subject: (getHeader('Subject') || '(æ— ä¸»é¢˜)').substring(0, 30),
      date: formatDate(getHeader('Date')),
      unread: detail.labelIds?.includes('UNREAD'),
      starred: detail.labelIds?.includes('STARRED')
    });
  }

  await storeMailIds(userId, mails, env);

  let text = \`ğŸ“¬ \${query.substring(0, 30)}\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n\`;
  mails.forEach((m, i) => {
    const icon = m.unread ? 'ğŸ”µ' : 'âšªï¸';
    const star = m.starred ? 'â­' : '';
    text += \`\${icon}\${star} \${i + 1}. \${m.subject}\\n    ğŸ“¤ \${m.from} Â· \${m.date}\\n\\n\`;
  });

  const buttons = [];
  
  for (let i = 0; i < mails.length; i += 3) {
    const row = [];
    for (let j = i; j < Math.min(i + 3, mails.length); j++) {
      const icon = mails[j].unread ? 'ğŸ”µ' : 'ğŸ“§';
      row.push({ text: \`\${icon} \${j + 1}\`, callback_data: \`m:\${j}\` });
    }
    buttons.push(row);
  }

  const navRow = [];
  navRow.push({ text: 'ğŸ”„ åˆ·æ–°', callback_data: \`ref:\${query.substring(0, 50)}\` });
  
  if (listData.nextPageToken) {
    const pageKey = \`page:\${userId}:\${Date.now()}\`;
    await env.USER_TOKENS.put(pageKey, JSON.stringify({ query, token: listData.nextPageToken }), { expirationTtl: 3600 });
    navRow.push({ text: 'â¡ï¸ ä¸‹ä¸€é¡µ', callback_data: \`pg:\${Date.now()}\` });
  }
  buttons.push(navRow);
  buttons.push([{ text: 'âœ… å…¨éƒ¨å·²è¯»', callback_data: 'readall' }]);

  const method = editMsgId ? 'editMessageText' : 'sendMessage';
  const params = {
    chat_id: chatId,
    text,
    reply_markup: { inline_keyboard: buttons }
  };
  if (editMsgId) params.message_id = editMsgId;
  
  await sendTelegram(env.BOT_TOKEN, method, params);
}

// ==================== é‚®ä»¶è¯¦æƒ… ====================
async function sendMailDetail(chatId, userId, mailId, editMsgId, showFull, env) {
  const account = await getActiveAccount(userId, env);
  
  if (!account) {
    await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç»‘å®šè´¦æˆ·',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  const resp = await fetch(
    \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
    { headers: { Authorization: \`Bearer \${account.access_token}\` } }
  );
  
  if (!resp.ok) {
    const method = editMsgId ? 'editMessageText' : 'sendMessage';
    await sendTelegram(env.BOT_TOKEN, method, {
      chat_id: chatId,
      message_id: editMsgId,
      text: 'âŒ è·å–é‚®ä»¶å¤±è´¥',
      reply_markup: { inline_keyboard: [[{ text: 'â¬…ï¸ è¿”å›', callback_data: 'back' }]] }
    });
    return;
  }

  const mail = await resp.json();
  const headers = mail.payload?.headers || [];
  const getHeader = (n) => headers.find(h => h.name.toLowerCase() === n.toLowerCase())?.value || '';

  const from = getHeader('From');
  const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';
  const date = formatDate(getHeader('Date'));
  const unread = mail.labelIds?.includes('UNREAD');
  const starred = mail.labelIds?.includes('STARRED');

  let fromName = from;
  let fromEmail = from;
  const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.[a-z]+/i);
  if (emailMatch) {
    fromEmail = emailMatch[0];
    fromName = from.replace(/[<>]/g, '').replace(emailMatch[0], '').replace(/"/g, '').trim() || fromEmail;
  }

  const maxLen = showFull ? MAX_CONTENT_LENGTH : PREVIEW_LENGTH;
  const content = extractContent(mail.payload, maxLen, showFull);
  const attachments = getAttachments(mail.payload);

  let text = \`\${unread ? 'ğŸ”µ æœªè¯»' : 'âšªï¸ å·²è¯»'}\${starred ? ' â­' : ''}\\n\`;
  text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n';
  text += \`ğŸ“‹ \${subject}\\n\\n\`;
  text += \`ğŸ‘¤ \${fromName}\\nğŸ“§ \${fromEmail}\\nğŸ• \${date}\\n\`;
  if (attachments.length) text += \`ğŸ“ é™„ä»¶: \${attachments.length} ä¸ª\\n\`;
  text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
  text += content;

  await env.USER_TOKENS.put(\`current:\${userId}\`, mailId, { expirationTtl: 3600 });

  const buttons = [];
  
  buttons.push([
    { text: unread ? 'âœ… å·²è¯»' : 'ğŸ“© æœªè¯»', callback_data: unread ? 'do:read' : 'do:unread' },
    { text: starred ? 'â­ å–æ¶ˆ' : 'â­ æ˜Ÿæ ‡', callback_data: starred ? 'do:unstar' : 'do:star' },
    { text: 'ğŸ—‘ï¸', callback_data: 'do:delete' }
  ]);

  if (!showFull && content.includes('(ç‚¹å‡»æŸ¥çœ‹å®Œæ•´)')) {
    buttons.push([{ text: 'ğŸ“– æŸ¥çœ‹å®Œæ•´å†…å®¹', callback_data: 'do:full' }]);
  }
  
  // ç½‘é¡µé¢„è§ˆæŒ‰é’®
  const viewLink = await generateViewLink(userId, mailId, account.email, env);
  buttons.push([{ text: 'ğŸŒ åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹', url: viewLink }]);

  const searchEmail = fromEmail.substring(0, 25);
  buttons.push([{ text: \`ğŸ” æœç´¢ \${fromName.substring(0, 10)} çš„é‚®ä»¶\`, callback_data: \`sf:\${searchEmail}\` }]);

  if (attachments.length > 0) {
    const attRow = [];
    attachments.slice(0, 3).forEach((att, i) => {
      attRow.push({ text: \`ğŸ“ \${att.name.substring(0, 10)}\`, callback_data: \`att:\${i}\` });
    });
    buttons.push(attRow);
  }

  buttons.push([{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'back' }]);

  const method = editMsgId ? 'editMessageText' : 'sendMessage';
  const params = {
    chat_id: chatId,
    text,
    reply_markup: { inline_keyboard: buttons }
  };
  if (editMsgId) params.message_id = editMsgId;
  
  await sendTelegram(env.BOT_TOKEN, method, params);
}

// ==================== å†…å®¹æå– ====================
function extractContent(payload, maxLen, isFullMode) {
  let bodyData = findBody(payload, 'text/plain') || findBody(payload, 'text/html');
  
  if (!bodyData) return '(æ— å†…å®¹)';

  try {
    const base64 = bodyData.replace(/-/g, '+').replace(/_/g, '/');
    let text = decodeBase64(base64);

    text = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');
    text = text.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');
    text = text.replace(/<br\\s*\\/?>/gi, '\\n');
    text = text.replace(/<\\/?(p|div|tr|li)[^>]*>/gi, '\\n');
    text = text.replace(/<[^>]+>/g, '');
    
    text = text.replace(/&nbsp;/gi, ' ');
    text = text.replace(/&amp;/gi, '&');
    text = text.replace(/&lt;/gi, '<');
    text = text.replace(/&gt;/gi, '>');
    text = text.replace(/&quot;/gi, '"');
    
    text = text.replace(/[ \\t]+/g, ' ');
    text = text.replace(/\\n\\s*\\n/g, '\\n\\n');
    text = text.trim();

    if (text.length > maxLen) {
      text = text.substring(0, maxLen);
      if (isFullMode) {
        text += '\\n\\n... (å†…å®¹è¿‡é•¿ï¼Œç‚¹å‡»æµè§ˆå™¨æŸ¥çœ‹å®Œæ•´)';
      } else {
        text += '\\n\\n... (ç‚¹å‡»æŸ¥çœ‹å®Œæ•´)';
      }
    }

    return text || '(æ— å†…å®¹)';
  } catch {
    return '(è§£æå¤±è´¥)';
  }
}

function findBody(part, mimeType) {
  if (part.mimeType === mimeType && part.body?.data) {
    return part.body.data;
  }
  if (part.parts) {
    for (const p of part.parts) {
      const found = findBody(p, mimeType);
      if (found) return found;
    }
  }
  return null;
}

function getAttachments(payload) {
  const atts = [];
  function scan(part) {
    if (part.filename && part.body?.attachmentId) {
      atts.push({
        name: part.filename,
        id: part.body.attachmentId,
        size: part.body.size || 0
      });
    }
    if (part.parts) part.parts.forEach(scan);
  }
  scan(payload);
  return atts;
}

// ==================== ç»Ÿè®¡ ====================
async function sendStats(chatId, userId, editMsgId, env) {
  const account = await getActiveAccount(userId, env);
  
  if (!account) {
    await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®šè´¦æˆ·',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  const token = account.access_token;
  const todayTs = getTodayTimestamp();

  const [profileResp, unreadResp, todayResp, starredResp] = await Promise.all([
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', { headers: { Authorization: \`Bearer \${token}\` } }),
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=1', { headers: { Authorization: \`Bearer \${token}\` } }),
    fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages?q=after:\${todayTs}&maxResults=1\`, { headers: { Authorization: \`Bearer \${token}\` } }),
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:starred&maxResults=1', { headers: { Authorization: \`Bearer \${token}\` } })
  ]);

  const profile = await profileResp.json();
  const unread = await unreadResp.json();
  const today = await todayResp.json();
  const starred = await starredResp.json();

  let text = 'ğŸ“Š *é‚®ç®±ç»Ÿè®¡*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
  text += \`ğŸ“§ \${profile.emailAddress}\\n\\n\`;
  text += \`ğŸ“¬ æœªè¯»: *\${unread.resultSizeEstimate || 0}*\\n\`;
  text += \`ğŸ“… ä»Šæ—¥: *\${today.resultSizeEstimate || 0}*\\n\`;
  text += \`â­ æ˜Ÿæ ‡: *\${starred.resultSizeEstimate || 0}*\\n\`;
  text += \`ğŸ“ æ€»æ•°: *\${profile.messagesTotal || 0}*\\n\`;

  const buttons = [
    [
      { text: 'ğŸ“¬ æŸ¥çœ‹æœªè¯»', callback_data: 'list:is:unread' },
      { text: 'ğŸ“… æŸ¥çœ‹ä»Šæ—¥', callback_data: \`list:after:\${todayTs}\` }
    ],
    [{ text: 'ğŸ”„ åˆ·æ–°', callback_data: 'stats:refresh' }]
  ];

  const method = editMsgId ? 'editMessageText' : 'sendMessage';
  const params = {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: { inline_keyboard: buttons }
  };
  if (editMsgId) params.message_id = editMsgId;
  
  await sendTelegram(env.BOT_TOKEN, method, params);
}

// ==================== è´¦æˆ·ç®¡ç† ====================
async function sendAccountManager(chatId, userId, editMsgId, env) {
  const accounts = await getAccountList(userId, env);
  const active = await env.USER_TOKENS.get(\`active:\${userId}\`);

  let text = 'ğŸ‘¤ *è´¦æˆ·ç®¡ç†*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
  
  if (accounts.length === 0) {
    text += 'ğŸ“­ å°šæœªç»‘å®šä»»ä½•è´¦æˆ·\\n\\nç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ';
  } else {
    text += \`å·²ç»‘å®š *\${accounts.length}* ä¸ªè´¦æˆ·:\\n\\n\`;
    accounts.forEach((email, i) => {
      const isActive = email === active;
      text += \`\${isActive ? 'âœ…' : 'âšªï¸'} \${i + 1}. \${email}\${isActive ? ' (å½“å‰)' : ''}\\n\`;
    });
  }

  const buttons = [];
  
  accounts.forEach((email, i) => {
    if (i % 2 === 0) buttons.push([]);
    const row = buttons[buttons.length - 1];
    const isActive = email === active;
    row.push({
      text: \`\${isActive ? 'âœ…' : 'ğŸ“§'} \${email.substring(0, 15)}\`,
      callback_data: \`sw:\${i}\`
    });
  });

  await env.USER_TOKENS.put(\`accmap:\${userId}\`, JSON.stringify(accounts), { expirationTtl: 3600 });

  buttons.push([
    { text: 'â• æ·»åŠ è´¦æˆ·', callback_data: 'add' },
    { text: 'ğŸ—‘ï¸ åˆ é™¤è´¦æˆ·', callback_data: 'delmenu' }
  ]);
  buttons.push([{ text: 'ğŸ”„ åˆ·æ–°', callback_data: 'acc:refresh' }]);

  const method = editMsgId ? 'editMessageText' : 'sendMessage';
  const params = {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: { inline_keyboard: buttons }
  };
  if (editMsgId) params.message_id = editMsgId;
  
  await sendTelegram(env.BOT_TOKEN, method, params);
}

// ==================== æ·»åŠ è´¦æˆ· ====================
async function sendLoginLink(chatId, userId, env) {
  const origin = await env.USER_TOKENS.get('origin');
  const nonce = crypto.randomUUID();
  await env.USER_TOKENS.put(\`nonce:\${userId}\`, nonce, { expirationTtl: 600 });

  const state = btoa(JSON.stringify({ userId, nonce }));
  const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  authUrl.searchParams.set('client_id', env.GOOGLE_CLIENT_ID);
  authUrl.searchParams.set('redirect_uri', \`\${origin}/oauth/callback\`);
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('scope', GMAIL_SCOPES);
  authUrl.searchParams.set('access_type', 'offline');
  authUrl.searchParams.set('prompt', 'consent');
  authUrl.searchParams.set('state', state);

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'ğŸ” *æ·»åŠ  Gmail è´¦æˆ·*\\n\\nè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æˆæƒ',
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ” æˆæƒ Gmail', url: authUrl.toString() }],
        [{ text: 'â¬…ï¸ è¿”å›', callback_data: 'acc:refresh' }]
      ]
    }
  });
}

// ==================== è®¾ç½® ====================
async function sendSettings(chatId, userId, env) {
  const active = await env.USER_TOKENS.get(\`active:\${userId}\`);
  let pushEnabled = false;
  
  if (active) {
    const pushData = await env.USER_TOKENS.get(\`push:\${userId}:\${active}\`);
    pushEnabled = pushData ? JSON.parse(pushData).enabled : false;
  }

  let text = 'âš™ï¸ *è®¾ç½®*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
  text += \`ğŸ‘¤ è´¦æˆ·: \${active || 'æœªç»‘å®š'}\\n\`;
  text += \`ğŸ”” æ¨é€: \${pushEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'}\\n\`;

  const buttons = [
    [{ text: 'ğŸ‘¤ è´¦æˆ·ç®¡ç†', callback_data: 'acc:refresh' }]
  ];

  if (env.PUBSUB_TOPIC && active) {
    buttons.push([{
      text: pushEnabled ? 'ğŸ”• å…³é—­æ¨é€' : 'ğŸ”” å¼€å¯æ¨é€',
      callback_data: pushEnabled ? 'push:off' : 'push:on'
    }]);
  }

  buttons.push([{ text: 'ğŸ” æœç´¢å¸®åŠ©', callback_data: 'help' }]);

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: { inline_keyboard: buttons }
  });
}

// ==================== æœç´¢å¸®åŠ© ====================
async function sendSearchHelp(chatId, env) {
  const text = 'ğŸ” *æœç´¢é‚®ä»¶*\\n\\nå‘é€: æœç´¢ å…³é”®è¯\\n\\n*ç¤ºä¾‹:*\\nâ€¢ æœç´¢ ä¼šè®®\\nâ€¢ æœç´¢ from:test@qq.com\\nâ€¢ æœç´¢ subject:å‘¨æŠ¥\\nâ€¢ æœç´¢ has:attachment';

  const buttons = [
    [
      { text: 'ğŸ“¬ æœªè¯»', callback_data: 'list:is:unread' },
      { text: 'â­ æ˜Ÿæ ‡', callback_data: 'list:is:starred' },
      { text: 'ğŸ“ é™„ä»¶', callback_data: 'list:has:attachment' }
    ],
    [
      { text: 'ğŸ“… æœ¬å‘¨', callback_data: 'list:newer_than:7d' },
      { text: 'ğŸ“† æœ¬æœˆ', callback_data: 'list:newer_than:30d' }
    ]
  ];

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: { inline_keyboard: buttons }
  });
}

// ==================== æ‰¹é‡å·²è¯» ====================
async function markAllRead(chatId, userId, env) {
  const account = await getActiveAccount(userId, env);
  
  if (!account) {
    await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®šè´¦æˆ·',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  const listResp = await fetch(
    'https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=100',
    { headers: { Authorization: \`Bearer \${account.access_token}\` } }
  );
  const listData = await listResp.json();

  if (!listData.messages?.length) {
    await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âœ… æ²¡æœ‰æœªè¯»é‚®ä»¶',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/batchModify', {
    method: 'POST',
    headers: {
      Authorization: \`Bearer \${account.access_token}\`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      ids: listData.messages.map(m => m.id),
      removeLabelIds: ['UNREAD']
    })
  });

  await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: \`âœ… å·²å°† *\${listData.messages.length}* å°é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»\`,
    parse_mode: 'Markdown',
    reply_markup: getMainKeyboard()
  });
}

// ==================== å›è°ƒå¤„ç† ====================
async function handleCallback(query, env) {
  const chatId = query.message.chat.id;
  const userId = String(query.from.id);
  const msgId = query.message.message_id;
  const data = query.data;

  await sendTelegram(env.BOT_TOKEN, 'answerCallbackQuery', {
    callback_query_id: query.id
  });

  if (data === 'stats:refresh') {
    await sendStats(chatId, userId, msgId, env);
    return;
  }

  if (data === 'acc:refresh') {
    await sendAccountManager(chatId, userId, msgId, env);
    return;
  }

  if (data === 'add') {
    await sendLoginLink(chatId, userId, env);
    return;
  }

  if (data.startsWith('sw:')) {
    const index = parseInt(data.substring(3));
    const accRaw = await env.USER_TOKENS.get(\`accmap:\${userId}\`);
    if (accRaw) {
      const accounts = JSON.parse(accRaw);
      if (accounts[index]) {
        await env.USER_TOKENS.put(\`active:\${userId}\`, accounts[index]);
      }
    }
    await sendAccountManager(chatId, userId, msgId, env);
    return;
  }

  if (data === 'delmenu') {
    const accounts = await getAccountList(userId, env);
    const buttons = accounts.map((email, i) => ([{
      text: \`ğŸ—‘ï¸ \${email}\`,
      callback_data: \`del:\${i}\`
    }]));
    buttons.push([{ text: 'â¬…ï¸ è¿”å›', callback_data: 'acc:refresh' }]);

    await sendTelegram(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: msgId,
      text: 'ğŸ—‘ï¸ é€‰æ‹©è¦åˆ é™¤çš„è´¦æˆ·:',
      reply_markup: { inline_keyboard: buttons }
    });
    return;
  }

  if (data.startsWith('del:')) {
    const index = parseInt(data.substring(4));
    const accounts = await getAccountList(userId, env);
    const email = accounts[index];
    
    if (email) {
      await env.USER_TOKENS.delete(\`token:\${userId}:\${email}\`);
      await env.USER_TOKENS.delete(\`push:\${userId}:\${email}\`);
      accounts.splice(index, 1);
      await env.USER_TOKENS.put(\`accounts:\${userId}\`, JSON.stringify(accounts));
      
      const active = await env.USER_TOKENS.get(\`active:\${userId}\`);
      if (active === email && accounts.length > 0) {
        await env.USER_TOKENS.put(\`active:\${userId}\`, accounts[0]);
      } else if (accounts.length === 0) {
        await env.USER_TOKENS.delete(\`active:\${userId}\`);
      }
    }
    
    await sendAccountManager(chatId, userId, msgId, env);
    return;
  }

  if (data === 'help') {
    await sendSearchHelp(chatId, env);
    return;
  }

  if (data.startsWith('list:')) {
    const query = data.substring(5);
    await sendMailList(chatId, userId, query, null, msgId, env);
    return;
  }

  if (data.startsWith('ref:')) {
    const query = data.substring(4);
    await sendMailList(chatId, userId, query, null, msgId, env);
    return;
  }

  if (data.startsWith('pg:')) {
    const ts = data.substring(3);
    const pageKey = \`page:\${userId}:\${ts}\`;
    const pageData = await env.USER_TOKENS.get(pageKey);
    if (pageData) {
      const { query, token } = JSON.parse(pageData);
      await sendMailList(chatId, userId, query, token, msgId, env);
    }
    return;
  }

  if (data.startsWith('m:')) {
    const index = parseInt(data.substring(2));
    const mailId = await getMailId(userId, index, env);
    if (mailId) {
      await sendMailDetail(chatId, userId, mailId, msgId, false, env);
    }
    return;
  }

  if (data.startsWith('do:')) {
    const action = data.substring(3);
    const mailId = await env.USER_TOKENS.get(\`current:\${userId}\`);
    
    if (!mailId) return;

    const account = await getActiveAccount(userId, env);
    if (!account) return;

    if (action === 'full') {
      await sendMailDetail(chatId, userId, mailId, msgId, true, env);
      return;
    }

    const actions = {
      read: { removeLabelIds: ['UNREAD'] },
      unread: { addLabelIds: ['UNREAD'] },
      star: { addLabelIds: ['STARRED'] },
      unstar: { removeLabelIds: ['STARRED'] }
    };

    if (actions[action]) {
      await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
        method: 'POST',
        headers: {
          Authorization: \`Bearer \${account.access_token}\`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(actions[action])
      });
      await sendMailDetail(chatId, userId, mailId, msgId, false, env);
      return;
    }

    if (action === 'delete') {
      await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/trash\`, {
        method: 'POST',
        headers: { Authorization: \`Bearer \${account.access_token}\` }
      });
      await sendTelegram(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: msgId,
        text: 'ğŸ—‘ï¸ å·²ç§»è‡³åƒåœ¾ç®±',
        reply_markup: { inline_keyboard: [[{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'back' }]] }
      });
      return;
    }
  }

  if (data.startsWith('sf:')) {
    const email = data.substring(3);
    await sendMailList(chatId, userId, \`from:\${email}\`, null, msgId, env);
    return;
  }

  if (data.startsWith('att:')) {
    const index = parseInt(data.substring(4));
    const mailId = await env.USER_TOKENS.get(\`current:\${userId}\`);
    const account = await getActiveAccount(userId, env);
    
    if (!mailId || !account) return;

    const mailResp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
      { headers: { Authorization: \`Bearer \${account.access_token}\` } }
    );
    const mail = await mailResp.json();
    const attachments = getAttachments(mail.payload);
    const att = attachments[index];

    if (!att) return;

    const attResp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/attachments/\${att.id}\`,
      { headers: { Authorization: \`Bearer \${account.access_token}\` } }
    );
    const attData = await attResp.json();

    const base64 = attData.data.replace(/-/g, '+').replace(/_/g, '/');
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('document', new Blob([bytes]), att.name);

    await fetch(\`https://api.telegram.org/bot\${env.BOT_TOKEN}/sendDocument\`, {
      method: 'POST',
      body: formData
    });
    return;
  }

  if (data === 'back') {
    const lastQuery = await env.USER_TOKENS.get(\`lastquery:\${userId}\`) || 'in:inbox';
    await sendMailList(chatId, userId, lastQuery, null, msgId, env);
    return;
  }

  if (data === 'readall') {
    await markAllRead(chatId, userId, env);
    return;
  }

  if (data === 'push:on' || data === 'push:off') {
    const enable = data === 'push:on';
    const active = await env.USER_TOKENS.get(\`active:\${userId}\`);
    
    if (!active) return;

    if (enable && env.PUBSUB_TOPIC) {
      const account = await getActiveAccount(userId, env);
      if (account) {
        const watchResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/watch', {
          method: 'POST',
          headers: {
            Authorization: \`Bearer \${account.access_token}\`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            topicName: env.PUBSUB_TOPIC,
            labelIds: ['INBOX']
          })
        });
        const watchData = await watchResp.json();
        
        await env.USER_TOKENS.put(\`push:\${userId}:\${active}\`, JSON.stringify({
          enabled: true,
          historyId: watchData.historyId,
          expiry: watchData.expiration
        }));
      }
    } else {
      await env.USER_TOKENS.put(\`push:\${userId}:\${active}\`, JSON.stringify({ enabled: false }));
    }

    await sendSettings(chatId, userId, env);
  }
}

// ==================== Pub/Sub æ¨é€ ====================
async function handlePubSubPush(message, env) {
  if (!message.message?.data) return;

  const data = JSON.parse(atob(message.message.data));
  const { emailAddress, historyId } = data;

  const list = await env.USER_TOKENS.list({ prefix: 'push:' });
  
  for (const key of list.keys) {
    const pushData = JSON.parse(await env.USER_TOKENS.get(key.name) || '{}');
    if (!pushData.enabled) continue;

    const parts = key.name.split(':');
    const usrId = parts[1];
    const email = parts.slice(2).join(':');
    
    if (email !== emailAddress) continue;

    const tokenRaw = await env.USER_TOKENS.get(\`token:\${usrId}:\${email}\`);
    if (!tokenRaw) continue;

    let token = JSON.parse(tokenRaw);
    
    if (Date.now() > token.expiry - 60000) {
      const refreshed = await refreshToken(token.refresh_token, env);
      if (refreshed) {
        token.access_token = refreshed.access_token;
        token.expiry = Date.now() + refreshed.expires_in * 1000;
        await env.USER_TOKENS.put(\`token:\${usrId}:\${email}\`, JSON.stringify(token));
      } else {
        continue;
      }
    }

    const historyResp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/history?startHistoryId=\${pushData.historyId || historyId}&historyTypes=messageAdded&labelId=INBOX\`,
      { headers: { Authorization: \`Bearer \${token.access_token}\` } }
    );
    const historyData = await historyResp.json();

    if (historyData.history) {
      for (const h of historyData.history) {
        if (h.messagesAdded) {
          for (const m of h.messagesAdded) {
            const mailResp = await fetch(
              \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${m.message.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject\`,
              { headers: { Authorization: \`Bearer \${token.access_token}\` } }
            );
            const mail = await mailResp.json();
            const headers = mail.payload?.headers || [];
            const from = headers.find(h => h.name === 'From')?.value || '';
            const subject = headers.find(h => h.name === 'Subject')?.value || '(æ— ä¸»é¢˜)';

            let fromName = from;
            const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.[a-z]+/i);
            if (emailMatch) {
              fromName = from.replace(emailMatch[0], '').replace(/[<>"]/g, '').trim() || emailMatch[0];
            }

            await env.USER_TOKENS.put(\`active:\${usrId}\`, email);
            await env.USER_TOKENS.put(\`current:\${usrId}\`, m.message.id, { expirationTtl: 3600 });

            const viewLink = await generateViewLink(usrId, m.message.id, email, env);

            await sendTelegram(env.BOT_TOKEN, 'sendMessage', {
              chat_id: usrId,
              text: \`ğŸ”” *æ–°é‚®ä»¶*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ“§ \${email}\\nğŸ‘¤ \${fromName}\\nğŸ“‹ \${subject}\`,
              parse_mode: 'Markdown',
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸŒ åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹', url: viewLink }],
                  [{ text: 'ğŸ“– åœ¨ Telegram æŸ¥çœ‹', callback_data: 'do:full' }],
                  [
                    { text: 'âœ… å·²è¯»', callback_data: 'do:read' },
                    { text: 'ğŸ—‘ï¸ åˆ é™¤', callback_data: 'do:delete' }
                  ]
                ]
              }
            });
          }
        }
      }
    }

    pushData.historyId = historyData.historyId || historyId;
    await env.USER_TOKENS.put(key.name, JSON.stringify(pushData));
  }
}

// ==================== ç»­æœŸ Watch ====================
async function renewAllWatches(env) {
  if (!env.PUBSUB_TOPIC) return;

  const list = await env.USER_TOKENS.list({ prefix: 'push:' });
  
  for (const key of list.keys) {
    const pushData = JSON.parse(await env.USER_TOKENS.get(key.name) || '{}');
    if (!pushData.enabled) continue;

    const parts = key.name.split(':');
    const usrId = parts[1];
    const email = parts.slice(2).join(':');

    const tokenRaw = await env.USER_TOKENS.get(\`token:\${usrId}:\${email}\`);
    if (!tokenRaw) continue;

    let token = JSON.parse(tokenRaw);
    
    if (Date.now() > token.expiry - 60000) {
      const refreshed = await refreshToken(token.refresh_token, env);
      if (refreshed) {
        token.access_token = refreshed.access_token;
        token.expiry = Date.now() + refreshed.expires_in * 1000;
        await env.USER_TOKENS.put(\`token:\${usrId}:\${email}\`, JSON.stringify(token));
      } else {
        continue;
      }
    }

    const watchResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/watch', {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${token.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        topicName: env.PUBSUB_TOPIC,
        labelIds: ['INBOX']
      })
    });
    const watchData = await watchResp.json();

    if (watchData.historyId) {
      pushData.historyId = watchData.historyId;
      pushData.expiry = watchData.expiration;
      await env.USER_TOKENS.put(key.name, JSON.stringify(pushData));
    }
  }
}

// ==================== é¡µé¢æ¨¡æ¿ ====================
function getHomePage() {
  return \`<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gmail Bot</title>
<style>body{font-family:system-ui;background:#1a1a2e;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.box{text-align:center;padding:40px}.emoji{font-size:4rem;margin-bottom:1rem}h1{margin:0 0 .5rem}p{opacity:.8;margin:0 0 1.5rem}
.badge{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;display:inline-block}</style></head>
<body><div class="box"><div class="emoji">ğŸ“§ğŸ¤–</div><h1>Gmail Telegram Bot</h1><p>æœåŠ¡è¿è¡Œä¸­</p>
<span class="badge">âœ… Active</span></div></body></html>\`;
}

function getResultPage(success, message) {
  const color = success ? '#10b981' : '#ef4444';
  const icon = success ? 'âœ“' : 'âœ•';
  const title = success ? 'æˆæƒæˆåŠŸ' : 'æˆæƒå¤±è´¥';
  
  return \`<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>\${title}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;
background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:20px}
.card{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:24px;padding:48px;text-align:center;
max-width:420px;width:100%;border:1px solid rgba(255,255,255,0.2);box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.icon{width:80px;height:80px;border-radius:50%;background:\${color};display:flex;align-items:center;justify-content:center;
font-size:40px;font-weight:bold;color:#fff;margin:0 auto 24px;box-shadow:0 10px 40px \${color}66}
h1{color:#fff;font-size:28px;margin-bottom:16px}
.email{background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.3);padding:16px 20px;border-radius:12px;
margin:24px 0;word-break:break-all;color:#e0e7ff;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:14px 32px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
color:#fff;text-decoration:none;border-radius:12px;font-weight:600;font-size:16px;transition:all 0.3s;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.5)}
.features{display:flex;justify-content:center;gap:24px;margin-top:32px;flex-wrap:wrap}
.feature{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.7);font-size:13px}
</style></head>
<body><div class="card">
<div class="icon">\${icon}</div>
<h1>\${title}</h1>
<div class="email">\${success ? 'ğŸ“§ ' + message : 'âŒ ' + message}</div>
<a href="https://t.me" class="btn">ğŸ“± æ‰“å¼€ Telegram</a>
\${success ? '<div class="features"><span class="feature">ğŸ”’ å®‰å…¨åŠ å¯†</span><span class="feature">âš¡ å®æ—¶åŒæ­¥</span><span class="feature">ğŸŒ ç½‘é¡µé¢„è§ˆ</span></div>' : ''}
</div></body></html>\`;
}`;

    // æ˜¾ç¤ºä»£ç 
    document.getElementById('workerCode').textContent = workerCode;
    Prism.highlightAll();

    // å¤åˆ¶åŠŸèƒ½
    document.getElementById('copyBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(workerCode);
        document.getElementById('copyIcon').textContent = 'âœ…';
        document.getElementById('copyText').textContent = 'å·²å¤åˆ¶!';
        setTimeout(() => {
          document.getElementById('copyIcon').textContent = 'ğŸ“‹';
          document.getElementById('copyText').textContent = 'å¤åˆ¶ä»£ç ';
        }, 2000);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = workerCode;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        document.getElementById('copyIcon').textContent = 'âœ…';
        document.getElementById('copyText').textContent = 'å·²å¤åˆ¶!';
      }
    });
  </script>
</body>
</html>

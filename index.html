<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot - Cloudflare Worker éƒ¨ç½²æŒ‡å—</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .code-container {
      max-height: 600px;
      overflow-y: auto;
    }
    pre[class*="language-"] {
      margin: 0;
      border-radius: 0.5rem;
    }
    .step-number {
      width: 32px;
      height: 32px;
      min-width: 32px;
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg py-12 px-4">
    <div class="max-w-5xl mx-auto text-center">
      <div class="flex items-center justify-center gap-4 mb-4">
        <span class="text-5xl">ğŸ“§</span>
        <span class="text-5xl">ğŸ¤–</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Gmail Telegram Bot</h1>
      <p class="text-xl text-purple-100 max-w-2xl mx-auto">
        åŸºäº Cloudflare Workers çš„ Telegram Botï¼Œå®‰å…¨è®¿é—® Gmail é‚®ç®±
      </p>
      <div class="flex flex-wrap justify-center gap-3 mt-6">
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âœ¨ å®Œå…¨å…è´¹</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”’ OAuth å®‰å…¨è®¤è¯</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âš¡ æŒ‰éœ€è§¦å‘</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸŒ æ— éœ€æœåŠ¡å™¨</span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-12">
    <!-- Features -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸš€</span> åŠŸèƒ½ç‰¹æ€§
      </h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“¬</div>
          <h3 class="font-semibold mb-1">æŸ¥çœ‹æœªè¯»é‚®ä»¶</h3>
          <p class="text-gray-400 text-sm">è·å–æœ€æ–° 8 å°æœªè¯»é‚®ä»¶ï¼Œæ˜¾ç¤ºå‘ä»¶äººã€ä¸»é¢˜ã€æ—¶é—´å’Œé¢„è§ˆ</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">æ™ºèƒ½æœç´¢</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒ Gmail æœç´¢è¯­æ³•ï¼Œå¦‚ from:xxx after:2024/01/01</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“</div>
          <h3 class="font-semibold mb-1">é™„ä»¶æ£€æµ‹</h3>
          <p class="text-gray-400 text-sm">è‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºé‚®ä»¶ä¸­çš„é™„ä»¶æ•°é‡</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">âœ…</div>
          <h3 class="font-semibold mb-1">ä¸€é”®æ ‡è®°å·²è¯»</h3>
          <p class="text-gray-400 text-sm">é€šè¿‡å†…è”æŒ‰é’®å¿«é€Ÿå°†é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">å®‰å…¨è®¤è¯</h3>
          <p class="text-gray-400 text-sm">ä½¿ç”¨ Google OAuth 2.0ï¼Œæ— éœ€æä¾›è´¦å·å¯†ç </p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”„</div>
          <h3 class="font-semibold mb-1">è‡ªåŠ¨åˆ·æ–° Token</h3>
          <p class="text-gray-400 text-sm">Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°ï¼Œæ— éœ€é‡å¤ç™»å½•</p>
        </div>
      </div>
    </section>

    <!-- Commands -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ’¬</span> æ”¯æŒçš„å‘½ä»¤
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å‘½ä»¤</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr><td class="px-5 py-3 font-mono text-purple-400">/start</td><td class="px-5 py-3 text-gray-300">æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’ŒåŠŸèƒ½èœå•</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/login</td><td class="px-5 py-3 text-gray-300">ç™»å½• Gmailï¼ˆæ˜¾ç¤ºæˆæƒæŒ‰é’®ï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/new</td><td class="px-5 py-3 text-gray-300">è·å–æœªè¯»é‚®ä»¶ï¼ˆæœ€æ–° 8 å°ï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/search å…³é”®è¯</td><td class="px-5 py-3 text-gray-300">æœç´¢é‚®ä»¶ï¼ˆæ”¯æŒ Gmail è¯­æ³•ï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/logout</td><td class="px-5 py-3 text-gray-300">é€€å‡ºç™»å½•ï¼Œåˆ é™¤ Token</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/help</td><td class="px-5 py-3 text-gray-300">æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Deployment Steps -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ“‹</span> éƒ¨ç½²æ­¥éª¤
      </h2>
      
      <div class="space-y-6">
        <!-- Step 1 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Telegram Bot</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æœç´¢ <code class="bg-gray-700 px-2 py-0.5 rounded">@BotFather</code></li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/newbot</code> åˆ›å»ºæ–° Bot</li>
                <li>æŒ‰æç¤ºè®¾ç½®åç§°ï¼Œè·å– <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">BOT_TOKEN</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Google OAuth å‡­è¯</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è®¿é—® <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-purple-400 hover:underline">Google Cloud Console</a></li>
                <li>åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚å·²æœ‰å¯è·³è¿‡ï¼‰</li>
                <li>åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼ˆé€‰æ‹© Web åº”ç”¨ç±»å‹ï¼‰</li>
                <li>æ·»åŠ æˆæƒé‡å®šå‘ URIï¼š
                  <code class="block bg-gray-700 px-3 py-2 rounded mt-1 text-sm break-all">https://your-worker.your-username.workers.dev/oauth/callback</code>
                </li>
                <li>å¯ç”¨ <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" class="text-purple-400 hover:underline">Gmail API</a></li>
                <li>è®°å½• <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_ID</code> å’Œ <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_SECRET</code></li>
              </ol>
              <div class="mt-3 p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-yellow-200 text-sm">
                âš ï¸ æ³¨æ„ï¼šå¦‚æœåº”ç”¨æœªå‘å¸ƒï¼Œéœ€åœ¨ OAuth åŒæ„å±å¹•æ·»åŠ æµ‹è¯•ç”¨æˆ·ï¼ˆä½ çš„ Gmail åœ°å€ï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Cloudflare Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>ç™»å½• <a href="https://dash.cloudflare.com" target="_blank" class="text-purple-400 hover:underline">Cloudflare Dashboard</a></li>
                <li>è¿›å…¥ Workers & Pages â†’ Create application â†’ Create Worker</li>
                <li>ç»™ Worker èµ·åï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-bot</code>ï¼‰</li>
                <li>ç‚¹å‡» Deploy åˆ›å»º</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">4</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º KV Namespace</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>Workers & Pages â†’ KV â†’ Create namespace</li>
                <li>åç§°å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
                <li>è¿›å…¥ Worker Settings â†’ Variables â†’ KV Namespace Bindings</li>
                <li>Add bindingï¼šVariable name å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">5</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">è®¾ç½®ç¯å¢ƒå˜é‡</h3>
              <p class="text-gray-300 mb-3">åœ¨ Worker Settings â†’ Variables â†’ Environment Variables æ·»åŠ ï¼š</p>
              <div class="bg-gray-900 rounded-lg p-4 space-y-2 font-mono text-sm">
                <div><span class="text-purple-400">BOT_TOKEN</span> = <span class="text-gray-400">ä½ çš„ Telegram Bot Token</span></div>
                <div><span class="text-purple-400">BOT_SECRET</span> = <span class="text-gray-400">è‡ªå®šä¹‰å¯†ç ï¼ˆå¦‚ mysecret123ï¼‰</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_ID</span> = <span class="text-gray-400">OAuth Client ID</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_SECRET</span> = <span class="text-gray-400">OAuth Client Secret</span></div>
              </div>
              <div class="mt-3 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                ğŸ’¡ å»ºè®®å°† GOOGLE_CLIENT_SECRET è®¾ä¸ºåŠ å¯†å˜é‡ï¼ˆEncryptï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">6</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">å¤åˆ¶ä»£ç åˆ° Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Worker é¡µé¢ç‚¹å‡» "Edit code" æˆ– "Quick edit"</li>
                <li>åˆ é™¤é»˜è®¤ä»£ç </li>
                <li>å¤åˆ¶ä¸‹æ–¹å®Œæ•´ä»£ç ç²˜è´´</li>
                <li>ç‚¹å‡» Save and Deploy</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 7 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">7</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">ä¸€é”®è®¾ç½® Webhook</h3>
              <p class="text-gray-300 mb-2">æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€å®Œæˆè®¾ç½®ï¼š</p>
              <code class="block bg-gray-700 px-3 py-2 rounded text-sm break-all">
                https://your-worker.workers.dev/setup?secret=ä½ çš„BOT_SECRET
              </code>
              <p class="text-gray-400 text-sm mt-2">çœ‹åˆ° "âœ… è®¾ç½®æˆåŠŸ" å³å®Œæˆ</p>
            </div>
          </div>
        </div>

        <!-- Step 8 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-green-500/50">
          <div class="flex gap-4">
            <div class="step-number bg-green-600 rounded-full flex items-center justify-center font-bold shrink-0">âœ“</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-green-400">å¼€å§‹ä½¿ç”¨ï¼</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æ‰¾åˆ°ä½ çš„ Bot</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/start</code> æŸ¥çœ‹èœå•</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/login</code> ç™»å½• Gmail</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/new</code> æŸ¥çœ‹æœªè¯»é‚®ä»¶</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Complete Code -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <span class="text-purple-400">ğŸ“„</span> å®Œæ•´ Worker ä»£ç 
        </h2>
        <button id="copyBtn" class="copy-btn bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
          <span id="copyIcon">ğŸ“‹</span>
          <span id="copyText">å¤åˆ¶ä»£ç </span>
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <div class="bg-gray-700/50 px-4 py-2 flex items-center gap-2 border-b border-gray-700">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-2 text-gray-400 text-sm font-mono">worker.js</span>
        </div>
        <div class="code-container">
          <pre><code class="language-javascript" id="workerCode"></code></pre>
        </div>
      </div>
    </section>

    <!-- Environment Variables -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âš™ï¸</span> ç¯å¢ƒå˜é‡è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å˜é‡å</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
              <th class="text-left px-5 py-3 font-semibold">ç¤ºä¾‹</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_TOKEN</td>
              <td class="px-5 py-3 text-gray-300">Telegram Bot Token</td>
              <td class="px-5 py-3 text-gray-400 text-sm">123456:ABC-DEF...</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_SECRET</td>
              <td class="px-5 py-3 text-gray-300">Webhook ä¿æŠ¤å¯†ç </td>
              <td class="px-5 py-3 text-gray-400 text-sm">mysecret123</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_ID</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Client ID</td>
              <td class="px-5 py-3 text-gray-400 text-sm">xxx.apps.googleusercontent.com</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_SECRET</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Secret (å»ºè®®åŠ å¯†)</td>
              <td class="px-5 py-3 text-gray-400 text-sm">GOCSPX-xxx</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ”§</span> å¸¸è§é—®é¢˜
      </h2>
      <div class="space-y-4">
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æˆæƒæ—¶æç¤º "Access blocked" æˆ– "æœªç»éªŒè¯çš„åº”ç”¨"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>è¿™æ˜¯å› ä¸º Google åº”ç”¨æœªå‘å¸ƒã€‚è§£å†³æ–¹æ³•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>è¿›å…¥ Google Cloud Console â†’ OAuth åŒæ„å±å¹•</li>
              <li>åœ¨"æµ‹è¯•ç”¨æˆ·"ä¸­æ·»åŠ ä½ çš„ Gmail åœ°å€</li>
              <li>æˆ–è€…å‘å¸ƒåº”ç”¨ï¼ˆéœ€è¦éªŒè¯ï¼‰</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æç¤º "redirect_uri_mismatch"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é‡å®šå‘ URI ä¸åŒ¹é…ã€‚ç¡®ä¿ Google Console ä¸­çš„æˆæƒé‡å®šå‘ URI å®Œå…¨åŒ¹é…ï¼š</p>
            <code class="block bg-gray-700 px-3 py-2 rounded mt-2 text-sm">https://your-worker.workers.dev/oauth/callback</code>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Bot æ²¡æœ‰å“åº”</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²è®¿é—® <code class="bg-gray-700 px-2 py-0.5 rounded">/setup?secret=xxx</code> è®¾ç½® Webhook</li>
              <li>æ£€æŸ¥ Worker æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯</li>
              <li>ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</li>
              <li>ç¡®è®¤ KV Namespace å·²ç»‘å®š</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">åœ¨ä¸­å›½å¤§é™†æ— æ³•æˆæƒ</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é¦–æ¬¡æˆæƒéœ€è¦è®¿é—® Googleï¼Œå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚æˆæƒæˆåŠŸåï¼ŒBot è°ƒç”¨ Gmail API æ˜¯é€šè¿‡ Cloudflare Workers å‘èµ·çš„ï¼Œä¸å—æœ¬åœ°ç½‘ç»œé™åˆ¶ã€‚</p>
          </div>
        </details>

        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Token åˆ·æ–°å¤±è´¥</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>å¯èƒ½åŸå› ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>ç”¨æˆ·æ’¤é”€äº†æˆæƒ â†’ éœ€è¦é‡æ–° /login</li>
              <li>Refresh Token è¿‡æœŸï¼ˆ6ä¸ªæœˆæœªä½¿ç”¨ï¼‰â†’ é‡æ–°ç™»å½•</li>
              <li>OAuth å‡­è¯è¢«åˆ é™¤æˆ–æ›´æ”¹ â†’ æ£€æŸ¥ Google Console</li>
            </ol>
          </div>
        </details>
      </div>
    </section>

    <!-- Architecture -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ—ï¸</span> æ¶æ„è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <div class="flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“±</div>
            <div class="text-sm">Telegram</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Cloudflare Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-red-600/20 border border-red-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“§</div>
            <div class="text-sm">Gmail API</div>
          </div>
        </div>
        <div class="mt-6 text-center text-gray-400 text-sm">
          <p>Cloudflare KV å­˜å‚¨ç”¨æˆ· Tokenï¼ŒWorker å¤„ç† Webhook å¹¶è°ƒç”¨ Gmail API</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800/50 border-t border-gray-700 py-8 px-4">
    <div class="max-w-5xl mx-auto text-center text-gray-400">
      <p>Gmail Telegram Bot - åŸºäº Cloudflare Workers</p>
      <p class="mt-2 text-sm">å®Œå…¨å…è´¹ Â· å®‰å…¨å¯é  Â· æŒ‰éœ€è§¦å‘</p>
    </div>
  </footer>

  <script>
    // Worker ä»£ç  - ä½¿ç”¨ JavaScript å­—ç¬¦ä¸²é¿å… HTML ç¼–ç é—®é¢˜
    const workerCode = `/**
 * Gmail Telegram Bot - Cloudflare Worker
 * åŠŸèƒ½ï¼šé€šè¿‡ Telegram Bot å®‰å…¨è®¿é—® Gmail é‚®ç®±
 * ç‰ˆæœ¬ï¼š2.1ï¼ˆä¼˜åŒ–ç‰ˆ - æ”¯æŒæ›´å¤šæ“ä½œæŒ‰é’®ï¼‰
 */

// ==================== é…ç½®å¸¸é‡ ====================
const GMAIL_SCOPES = [
  'https://www.googleapis.com/auth/gmail.readonly',
  'https://www.googleapis.com/auth/gmail.modify'
].join(' ');

const MAX_EMAILS = 8;
const PREVIEW_LENGTH = 300;
const MAX_CONTENT_LENGTH = 3500;
const TOKEN_REFRESH_BUFFER = 60000;

// ==================== ä¸»å…¥å£ ====================
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    try {
      if (path === '/setup') {
        return await handleSetup(url, env);
      }
      
      if (path === '/oauth/callback') {
        return await handleOAuthCallback(request, env);
      }
      
      if (path === '/webhook' && request.method === 'POST') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return jsonResponse({ error: 'Unauthorized' }, 401);
        }
        const update = await request.json();
        ctx.waitUntil(handleBotUpdate(update, env, url.origin));
        return jsonResponse({ ok: true });
      }

      return new Response(generateHomePage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    } catch (error) {
      console.error('Error:', error);
      return jsonResponse({ error: error.message }, 500);
    }
  }
};

// ==================== Webhook è®¾ç½® ====================
async function handleSetup(url, env) {
  const secret = url.searchParams.get('secret');
  if (secret !== env.BOT_SECRET) {
    return new Response('âŒ é”™è¯¯ï¼šè¯·æä¾›æ­£ç¡®çš„ secret å‚æ•°', { 
      status: 401,
      headers: { 'Content-Type': 'text/plain; charset=utf-8' }
    });
  }

  const webhookUrl = \`\${url.origin}/webhook?secret=\${env.BOT_SECRET}\`;
  const results = [];

  const webhookResp = await telegramAPI(env.BOT_TOKEN, 'setWebhook', { 
    url: webhookUrl,
    allowed_updates: ['message', 'callback_query']
  });
  results.push(\`Webhook: \${webhookResp.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\`);

  const commands = [
    { command: 'start', description: 'ğŸ  å¼€å§‹ä½¿ç”¨' },
    { command: 'login', description: 'ğŸ” ç™»å½• Gmail' },
    { command: 'new', description: 'ğŸ“¬ æŸ¥çœ‹æœªè¯»é‚®ä»¶' },
    { command: 'search', description: 'ğŸ” æœç´¢é‚®ä»¶' },
    { command: 'logout', description: 'ğŸšª é€€å‡ºç™»å½•' },
    { command: 'help', description: 'â“ å¸®åŠ©ä¿¡æ¯' }
  ];
  
  const commandsResp = await telegramAPI(env.BOT_TOKEN, 'setMyCommands', { commands });
  results.push(\`å‘½ä»¤èœå•: \${commandsResp.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\`);

  const meResp = await telegramAPI(env.BOT_TOKEN, 'getMe');
  if (meResp.ok) {
    results.push(\`\\nBot: @\${meResp.result.username}\`);
  }

  return new Response(\`ğŸ¤– Gmail Bot è®¾ç½®ç»“æœ\\n\${'='.repeat(30)}\\n\${results.join('\\n')}\\n\\nç°åœ¨å¯ä»¥åœ¨ Telegram ä¸­ä½¿ç”¨ Bot äº†ï¼\`, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' }
  });
}

// ==================== OAuth å›è°ƒå¤„ç† ====================
async function handleOAuthCallback(request, env) {
  const url = new URL(request.url);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');

  if (error) {
    return new Response(generateErrorPage(error), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  if (!code || !state) {
    return new Response(generateErrorPage('ç¼ºå°‘å¿…è¦å‚æ•°'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  let stateData;
  try {
    stateData = JSON.parse(atob(state));
  } catch {
    return new Response(generateErrorPage('State æ— æ•ˆ'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const { userId, nonce } = stateData;
  
  const storedNonce = await env.USER_TOKENS.get(\`nonce:\${userId}\`);
  if (!storedNonce || storedNonce !== nonce) {
    return new Response(generateErrorPage('æˆæƒå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const tokenResp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      code,
      client_id: env.GOOGLE_CLIENT_ID,
      client_secret: env.GOOGLE_CLIENT_SECRET,
      redirect_uri: \`\${url.origin}/oauth/callback\`,
      grant_type: 'authorization_code'
    })
  });

  const tokenData = await tokenResp.json();

  if (!tokenData.access_token) {
    console.error('Token exchange failed:', tokenData);
    return new Response(generateErrorPage(tokenData.error_description || tokenData.error || 'Token è·å–å¤±è´¥'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const profileResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {
    headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
  });
  const profile = await profileResp.json();

  await env.USER_TOKENS.put(\`token:\${userId}\`, JSON.stringify({
    access_token: tokenData.access_token,
    refresh_token: tokenData.refresh_token,
    expiry: Date.now() + (tokenData.expires_in * 1000),
    email: profile.emailAddress || 'unknown'
  }));

  await env.USER_TOKENS.delete(\`nonce:\${userId}\`);

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: userId,
    text: \`âœ… *ç™»å½•æˆåŠŸï¼*\\n\\nğŸ“§ å·²ç»‘å®š: \\\`\${profile.emailAddress || 'Gmail'}\\\`\\n\\nå‘é€ /new æŸ¥çœ‹æœªè¯»é‚®ä»¶\`,
    parse_mode: 'Markdown'
  });

  return new Response(generateSuccessPage(profile.emailAddress || 'Gmail'), {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

// ç”ŸæˆæˆæƒæˆåŠŸé¡µé¢
function generateSuccessPage(email) {
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæƒæˆåŠŸ - Gmail Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px;
      text-align: center;
      max-width: 420px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
      box-shadow: 0 10px 30px rgba(16,185,129,0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #10b981, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .email {
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 15px;
      color: #a5b4fc;
      border: 1px solid rgba(165,180,252,0.3);
    }
    .hint {
      color: #94a3b8;
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 32px;
      background: linear-gradient(135deg, #0088cc 0%, #0077b5 100%);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,136,204,0.4);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,136,204,0.5);
    }
    .features {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .feature { text-align: center; font-size: 12px; color: #94a3b8; }
    .feature-icon { font-size: 20px; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">âœ“</div>
    <h1>æˆæƒæˆåŠŸï¼</h1>
    <p style="color:#e2e8f0;margin-bottom:8px;">æ‚¨çš„ Gmail è´¦å·å·²æˆåŠŸç»‘å®š</p>
    <div class="email">ğŸ“§ \${email}</div>
    <p class="hint">ç°åœ¨å¯ä»¥è¿”å› Telegram ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š<br><strong>/new</strong> æŸ¥çœ‹æœªè¯»é‚®ä»¶ Â· <strong>/search</strong> æœç´¢é‚®ä»¶</p>
    <a href="https://t.me" class="btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>
      æ‰“å¼€ Telegram
    </a>
    <div class="features">
      <div class="feature"><div class="feature-icon">ğŸ”’</div><div>å®‰å…¨åŠ å¯†</div></div>
      <div class="feature"><div class="feature-icon">ğŸ“¬</div><div>å®æ—¶æŸ¥è¯¢</div></div>
      <div class="feature"><div class="feature-icon">ğŸ”</div><div>æ™ºèƒ½æœç´¢</div></div>
    </div>
  </div>
</body>
</html>\`;
}

// ç”Ÿæˆé”™è¯¯é¡µé¢
function generateErrorPage(errorMsg) {
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæƒå¤±è´¥ - Gmail Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px;
      text-align: center;
      max-width: 420px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }
    h1 { font-size: 24px; color: #f87171; margin-bottom: 16px; }
    .error { color: #94a3b8; margin-bottom: 24px; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      text-decoration: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">âœ•</div>
    <h1>æˆæƒå¤±è´¥</h1>
    <p class="error">\${errorMsg}</p>
    <a href="https://t.me" class="btn">è¿”å› Telegram é‡è¯•</a>
  </div>
</body>
</html>\`;
}

// ==================== Bot æ›´æ–°å¤„ç† ====================
async function handleBotUpdate(update, env, origin) {
  if (update.callback_query) {
    await handleCallbackQuery(update.callback_query, env, origin);
    return;
  }

  if (!update.message?.text) return;

  const msg = update.message;
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  const text = msg.text.trim();

  const [command, ...args] = text.split(/\\s+/);
  const cmd = command.toLowerCase().replace(/^\\//, '').replace(/@.*$/, '');

  switch (cmd) {
    case 'start':
    case 'help':
      await sendWelcome(chatId, env);
      break;
    case 'login':
      await sendLoginLink(chatId, userId, origin, env);
      break;
    case 'logout':
      await handleLogout(chatId, userId, env);
      break;
    case 'new':
    case 'unread':
    case 'get':
      await handleGetMails(chatId, userId, 'is:unread', env);
      break;
    case 'search':
      const query = args.join(' ');
      if (!query) {
        await sendMessage(chatId, 'è¯·è¾“å…¥æœç´¢å…³é”®è¯\\n\\nä¾‹å¦‚ï¼š\\n/search é¡¹ç›®æŠ¥å‘Š\\n/search from:test@example.com\\n/search after:2024/01/01', env);
      } else {
        await handleGetMails(chatId, userId, query, env);
      }
      break;
  }
}

// ==================== å‘½ä»¤å¤„ç†å‡½æ•° ====================
async function sendWelcome(chatId, env) {
  const keyboard = {
    inline_keyboard: [
      [
        { text: 'ğŸ” ç™»å½• Gmail', callback_data: 'action:login' },
        { text: 'ğŸ“¬ æœªè¯»é‚®ä»¶', callback_data: 'action:new' }
      ],
      [
        { text: 'ğŸ” æœç´¢é‚®ä»¶', callback_data: 'action:search_help' },
        { text: 'ğŸšª é€€å‡ºç™»å½•', callback_data: 'action:logout' }
      ]
    ]
  };

  const text = \`ğŸ¤– *Gmail Bot*

æ¬¢è¿ä½¿ç”¨ Gmail é‚®ä»¶åŠ©æ‰‹ï¼

*å¯ç”¨å‘½ä»¤ï¼š*
/login - ç™»å½• Gmail
/new - æŸ¥çœ‹æœªè¯»é‚®ä»¶
/search å…³é”®è¯ - æœç´¢é‚®ä»¶
/logout - é€€å‡ºç™»å½•

*æœç´¢æŠ€å·§ï¼š*
â€¢ \\\`/search ä¼šè®®\\\` - æœç´¢åŒ…å«"ä¼šè®®"çš„é‚®ä»¶
â€¢ \\\`/search from:test@qq.com\\\` - æœç´¢æŒ‡å®šå‘ä»¶äºº
â€¢ \\\`/search after:2024/01/01\\\` - æœç´¢æŸæ—¥æœŸåçš„é‚®ä»¶
â€¢ \\\`/search has:attachment\\\` - æœç´¢æœ‰é™„ä»¶çš„é‚®ä»¶

ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¿«é€Ÿæ“ä½œ ğŸ‘‡\`;

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

async function sendLoginLink(chatId, userId, origin, env) {
  await env.USER_TOKENS.put('worker_origin', origin);
  
  const nonce = crypto.randomUUID();
  await env.USER_TOKENS.put(\`nonce:\${userId}\`, nonce, { expirationTtl: 600 });

  const state = btoa(JSON.stringify({ userId, nonce }));
  
  const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  authUrl.searchParams.set('client_id', env.GOOGLE_CLIENT_ID);
  authUrl.searchParams.set('redirect_uri', \`\${origin}/oauth/callback\`);
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('scope', GMAIL_SCOPES);
  authUrl.searchParams.set('access_type', 'offline');
  authUrl.searchParams.set('prompt', 'consent');
  authUrl.searchParams.set('state', state);

  const keyboard = {
    inline_keyboard: [[
      { text: 'ğŸ” ç‚¹å‡»ç™»å½• Gmail', url: authUrl.toString() }
    ]]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç™»å½• Gmail\\n\\nğŸ”’ ä½¿ç”¨ Google å®˜æ–¹æˆæƒï¼Œä»…è·å–é‚®ä»¶è¯»å–æƒé™',
    reply_markup: keyboard
  });
}

async function handleLogout(chatId, userId, env) {
  await env.USER_TOKENS.delete(\`token:\${userId}\`);
  await sendMessage(chatId, 'âœ… å·²é€€å‡ºç™»å½•ï¼ŒToken å·²åˆ é™¤\\n\\nä½¿ç”¨ /login é‡æ–°ç™»å½•', env);
}

async function handleGetMails(chatId, userId, query, env) {
  const tokenData = await getValidToken(userId, env);
  if (!tokenData) {
    await sendMessage(chatId, 'âš ï¸ æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ\\n\\nè¯·ä½¿ç”¨ /login ç™»å½•', env);
    return;
  }

  const loadingMsg = await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'ğŸ” æ­£åœ¨æŸ¥è¯¢é‚®ä»¶...'
  });

  try {
    const listUrl = new URL('https://gmail.googleapis.com/gmail/v1/users/me/messages');
    listUrl.searchParams.set('q', query);
    listUrl.searchParams.set('maxResults', MAX_EMAILS.toString());

    const listResp = await fetch(listUrl, {
      headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
    });

    if (!listResp.ok) {
      const error = await listResp.json();
      throw new Error(error.error?.message || 'API è¯·æ±‚å¤±è´¥');
    }

    const listData = await listResp.json();
    const messages = listData.messages || [];

    await telegramAPI(env.BOT_TOKEN, 'deleteMessage', {
      chat_id: chatId,
      message_id: loadingMsg.result.message_id
    });

    if (messages.length === 0) {
      await sendMessage(chatId, \`ğŸ“­ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é‚®ä»¶\\n\\næœç´¢æ¡ä»¶: \\\`\${query}\\\`\`, env, 'Markdown');
      return;
    }

    await sendMessage(chatId, \`ğŸ“¬ æ‰¾åˆ° \${messages.length} å°é‚®ä»¶ï¼ˆæœç´¢: \\\`\${query}\\\`ï¼‰\`, env, 'Markdown');

    for (const msg of messages) {
      await sendMailDetail(chatId, msg.id, tokenData.access_token, env, false);
    }
  } catch (error) {
    console.error('Get mails error:', error);
    await telegramAPI(env.BOT_TOKEN, 'deleteMessage', {
      chat_id: chatId,
      message_id: loadingMsg.result.message_id
    }).catch(() => {});
    await sendMessage(chatId, \`âŒ æŸ¥è¯¢å¤±è´¥: \${error.message}\`, env);
  }
}

async function sendMailDetail(chatId, messageId, accessToken, env, showFull = false) {
  const detailUrl = \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${messageId}?format=full\`;
  const detailResp = await fetch(detailUrl, {
    headers: { Authorization: \`Bearer \${accessToken}\` }
  });

  if (!detailResp.ok) return;

  const mail = await detailResp.json();
  const headers = mail.payload?.headers || [];
  
  const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';
  
  const from = getHeader('From');
  const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';
  const date = getHeader('Date');
  const isUnread = mail.labelIds?.includes('UNREAD');

  // è§£æå‘ä»¶äºº
  let fromName = from;
  let fromEmail = from;
  const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
  if (emailMatch) {
    fromEmail = emailMatch[0];
    fromName = from.replace(/[<>]/g, '').replace(emailMatch[0], '').replace(/"/g, '').trim() || fromEmail;
  }

  // æ ¼å¼åŒ–æ—¶é—´
  let dateStr = '';
  try {
    const d = new Date(date);
    dateStr = d.toLocaleString('zh-CN', { 
      month: '2-digit', 
      day: '2-digit', 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  } catch {
    dateStr = date;
  }

  // æå–é‚®ä»¶æ­£æ–‡
  const fullContent = extractEmailContent(mail.payload);
  const content = showFull ? fullContent : (fullContent.length > PREVIEW_LENGTH ? fullContent.substring(0, PREVIEW_LENGTH) + '\\n\\n... (ç‚¹å‡»"æŸ¥çœ‹å®Œæ•´"æ˜¾ç¤ºå…¨éƒ¨)' : fullContent);

  // æ£€æµ‹é™„ä»¶
  const attachments = detectAttachments(mail.payload);

  // æ„å»ºæ¶ˆæ¯
  let text = \`\${isUnread ? 'ğŸ”µ æœªè¯»' : 'âšªï¸ å·²è¯»'} | \${subject}\\n\`;
  text += \`\${'â”€'.repeat(20)}\\n\`;
  text += \`ğŸ‘¤ å‘ä»¶äºº: \${fromName}\\n\`;
  if (fromName !== fromEmail) {
    text += \`ğŸ“§ é‚®ç®±: \${fromEmail}\\n\`;
  }
  text += \`ğŸ• æ—¶é—´: \${dateStr}\\n\`;
  
  if (attachments.length > 0) {
    text += \`ğŸ“ é™„ä»¶ (\${attachments.length}): \${attachments.map(a => a.name).join(', ')}\\n\`;
  }
  
  text += \`\${'â”€'.repeat(20)}\\n\`;
  text += \`ğŸ“„ æ­£æ–‡:\\n\\n\${content}\`;

  // æ„å»ºæŒ‰é’® - ç¬¬ä¸€è¡Œæ˜¾ç¤ºä¸»è¦æ“ä½œï¼Œç¬¬äºŒè¡Œæ˜¾ç¤º"æ›´å¤š"å±•å¼€æŒ‰é’®
  const buttons = [];
  
  if (isUnread) {
    buttons.push([{ text: 'âœ… æ ‡è®°å·²è¯»', callback_data: \`read:\${messageId}\` }]);
  }
  
  // æ›´å¤šæ“ä½œæŒ‰é’®
  const moreButtons = [];
  if (!showFull && fullContent.length > PREVIEW_LENGTH) {
    moreButtons.push({ text: 'ğŸ“– æŸ¥çœ‹å®Œæ•´', callback_data: \`full:\${messageId}\` });
  }
  moreButtons.push({ text: 'ğŸ—‘ï¸ åˆ é™¤é‚®ä»¶', callback_data: \`delete:\${messageId}\` });
  moreButtons.push({ text: 'â­ åŠ æ˜Ÿæ ‡', callback_data: \`star:\${messageId}\` });
  
  buttons.push(moreButtons);

  const keyboard = { inline_keyboard: buttons };

  try {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text,
      reply_markup: keyboard
    });
  } catch (e) {
    const simpleText = \`\${isUnread ? 'ğŸ”µ' : 'âšªï¸'} \${subject}\\n\\nğŸ‘¤ \${fromName}\\nğŸ“§ \${fromEmail}\\nğŸ• \${dateStr}\\n\\n(é‚®ä»¶å†…å®¹åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè¯·åœ¨ Gmail ä¸­æŸ¥çœ‹)\`;
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: simpleText,
      reply_markup: keyboard
    });
  }
}

// ==================== å›è°ƒæŸ¥è¯¢å¤„ç† ====================
async function handleCallbackQuery(query, env, origin) {
  const chatId = query.message.chat.id;
  const userId = query.from.id.toString();
  const data = query.data;
  const messageId = query.message.message_id;

  // å¤„ç†åŠ¨ä½œæŒ‰é’®
  if (data.startsWith('action:')) {
    const action = data.split(':')[1];
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id });
    
    switch (action) {
      case 'login':
        const savedOrigin = await env.USER_TOKENS.get('worker_origin');
        if (savedOrigin) {
          await sendLoginLink(chatId, userId, savedOrigin, env);
        } else {
          await sendMessage(chatId, 'è¯·å‘é€ /login å‘½ä»¤ç™»å½•', env);
        }
        break;
      case 'new':
        await handleGetMails(chatId, userId, 'is:unread', env);
        break;
      case 'search_help':
        await sendMessage(chatId, 'è¯·å‘é€ /search å…³é”®è¯ è¿›è¡Œæœç´¢\\n\\nä¾‹å¦‚ï¼š/search ä¼šè®®', env);
        break;
      case 'logout':
        await handleLogout(chatId, userId, env);
        break;
    }
    return;
  }

  // è·å– Token
  const tokenData = await getValidToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
      callback_query_id: query.id,
      text: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–° /login'
    });
    return;
  }

  // æŸ¥çœ‹å®Œæ•´é‚®ä»¶
  if (data.startsWith('full:')) {
    const mailId = data.split(':')[1];
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { 
      callback_query_id: query.id,
      text: 'æ­£åœ¨åŠ è½½å®Œæ•´å†…å®¹...'
    });
    
    // åˆ é™¤å½“å‰æ¶ˆæ¯ï¼Œå‘é€å®Œæ•´ç‰ˆ
    await telegramAPI(env.BOT_TOKEN, 'deleteMessage', {
      chat_id: chatId,
      message_id: messageId
    });
    
    await sendMailDetail(chatId, mailId, tokenData.access_token, env, true);
    return;
  }

  // æ ‡è®°å·²è¯»
  if (data.startsWith('read:')) {
    const mailId = data.split(':')[1];
    try {
      await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
        method: 'POST',
        headers: {
          Authorization: \`Bearer \${tokenData.access_token}\`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ removeLabelIds: ['UNREAD'] })
      });

      const newText = query.message.text.replace('ğŸ”µ æœªè¯»', 'âšªï¸ å·²è¯»');
      const newButtons = query.message.reply_markup.inline_keyboard.filter(row => 
        !row.some(btn => btn.callback_data?.startsWith('read:'))
      );
      
      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: messageId,
        text: newText + '\\n\\nâœ… å·²æ ‡è®°ä¸ºå·²è¯»',
        reply_markup: { inline_keyboard: newButtons }
      });

      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'âœ… å·²æ ‡è®°ä¸ºå·²è¯»'
      });
    } catch (error) {
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'æ“ä½œå¤±è´¥: ' + error.message
      });
    }
    return;
  }

  // åˆ é™¤é‚®ä»¶
  if (data.startsWith('delete:')) {
    const mailId = data.split(':')[1];
    try {
      await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/trash\`, {
        method: 'POST',
        headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
      });

      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: messageId,
        text: 'ğŸ—‘ï¸ é‚®ä»¶å·²ç§»è‡³åƒåœ¾ç®±'
      });

      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'ğŸ—‘ï¸ å·²åˆ é™¤'
      });
    } catch (error) {
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'åˆ é™¤å¤±è´¥'
      });
    }
    return;
  }

  // åŠ æ˜Ÿæ ‡
  if (data.startsWith('star:')) {
    const mailId = data.split(':')[1];
    try {
      await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
        method: 'POST',
        headers: {
          Authorization: \`Bearer \${tokenData.access_token}\`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ addLabelIds: ['STARRED'] })
      });

      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'â­ å·²æ·»åŠ æ˜Ÿæ ‡'
      });
    } catch (error) {
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'æ“ä½œå¤±è´¥'
      });
    }
    return;
  }
}

// ==================== å·¥å…·å‡½æ•° ====================
async function getValidToken(userId, env) {
  const raw = await env.USER_TOKENS.get(\`token:\${userId}\`);
  if (!raw) return null;

  let tokenData;
  try {
    tokenData = JSON.parse(raw);
  } catch {
    return null;
  }

  if (Date.now() > tokenData.expiry - TOKEN_REFRESH_BUFFER) {
    if (!tokenData.refresh_token) return null;

    try {
      const refreshResp = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: env.GOOGLE_CLIENT_ID,
          client_secret: env.GOOGLE_CLIENT_SECRET,
          refresh_token: tokenData.refresh_token,
          grant_type: 'refresh_token'
        })
      });

      const newToken = await refreshResp.json();
      if (!newToken.access_token) return null;

      tokenData.access_token = newToken.access_token;
      tokenData.expiry = Date.now() + (newToken.expires_in * 1000);

      await env.USER_TOKENS.put(\`token:\${userId}\`, JSON.stringify(tokenData));
    } catch {
      return null;
    }
  }

  return tokenData;
}

function extractEmailContent(payload) {
  let bodyData = null;

  function findTextPart(part) {
    if (part.mimeType === 'text/plain' && part.body?.data) {
      return part.body.data;
    }
    if (part.parts) {
      for (const p of part.parts) {
        const result = findTextPart(p);
        if (result) return result;
      }
    }
    return null;
  }

  bodyData = findTextPart(payload);
  
  if (!bodyData) {
    function findHtmlPart(part) {
      if (part.mimeType === 'text/html' && part.body?.data) {
        return part.body.data;
      }
      if (part.parts) {
        for (const p of part.parts) {
          const result = findHtmlPart(p);
          if (result) return result;
        }
      }
      return null;
    }
    bodyData = findHtmlPart(payload);
  }

  if (!bodyData && payload.body?.data) {
    bodyData = payload.body.data;
  }

  if (!bodyData) return '(æ— å†…å®¹)';

  try {
    const base64 = bodyData.replace(/-/g, '+').replace(/_/g, '/');
    const decoded = decodeBase64(base64);
    
    let text = decoded;
    
    // ç§»é™¤ style å’Œ script æ ‡ç­¾
    text = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');
    text = text.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');
    
    // è½¬æ¢æ¢è¡Œæ ‡ç­¾
    text = text.replace(/<br\\s*\\/?>/gi, '\\n');
    text = text.replace(/<\\/p>/gi, '\\n');
    text = text.replace(/<\\/div>/gi, '\\n');
    text = text.replace(/<\\/tr>/gi, '\\n');
    text = text.replace(/<\\/li>/gi, '\\n');
    
    // ç§»é™¤ HTML æ ‡ç­¾
    text = text.replace(/<[^>]*>/g, '');
    
    // è§£ç  HTML å®ä½“
    text = text.replace(/&nbsp;/gi, ' ');
    text = text.replace(/&amp;/gi, '&');
    text = text.replace(/&lt;/gi, '<');
    text = text.replace(/&gt;/gi, '>');
    text = text.replace(/&quot;/gi, '"');
    text = text.replace(/&#39;/gi, "'");
    text = text.replace(/&hellip;/gi, '...');
    text = text.replace(/&#\\d+;/g, '');
    
    // æ¸…ç†ç©ºç™½
    text = text.replace(/[ \\t]+/g, ' ');
    text = text.replace(/\\n\\s*\\n/g, '\\n\\n');
    text = text.replace(/^\\s+|\\s+$/g, '');
    
    if (text.length > MAX_CONTENT_LENGTH) {
      text = text.substring(0, MAX_CONTENT_LENGTH) + '\\n\\n... (å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­)';
    }
    
    return text || '(æ— å†…å®¹)';
  } catch (e) {
    return '(æ— æ³•è§£æå†…å®¹)';
  }
}

function detectAttachments(payload) {
  const attachments = [];

  function scan(part) {
    if (part.filename && part.filename.trim() && part.body?.attachmentId) {
      attachments.push({
        name: part.filename,
        mimeType: part.mimeType,
        size: part.body.size
      });
    }
    if (part.parts) {
      part.parts.forEach(scan);
    }
  }

  scan(payload);
  return attachments;
}

function decodeBase64(base64) {
  try {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return new TextDecoder('utf-8').decode(bytes);
  } catch {
    return atob(base64);
  }
}

async function telegramAPI(token, method, params = {}) {
  const resp = await fetch(\`https://api.telegram.org/bot\${token}/\${method}\`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params)
  });
  return resp.json();
}

async function sendMessage(chatId, text, env, parseMode = null) {
  const params = { chat_id: chatId, text };
  if (parseMode) params.parse_mode = parseMode;
  return telegramAPI(env.BOT_TOKEN, 'sendMessage', params);
}

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
}

function generateHomePage() {
  return \`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, sans-serif; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    .container { text-align: center; padding: 40px; }
    h1 { font-size: 3rem; margin-bottom: 1rem; }
    .emoji { font-size: 4rem; margin-bottom: 1rem; }
    p { color: #94a3b8; font-size: 1.1rem; margin-bottom: 2rem; }
    .status { 
      background: #22c55e20; 
      border: 1px solid #22c55e50;
      padding: 12px 24px;
      border-radius: 50px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="emoji">ğŸ“§ğŸ¤–</div>
    <h1>Gmail Bot</h1>
    <p>Telegram Bot æ­£åœ¨è¿è¡Œä¸­</p>
    <div class="status">âœ… æœåŠ¡æ­£å¸¸</div>
  </div>
</body>
</html>\`;
}`;

    // å°†ä»£ç å¡«å……åˆ°é¡µé¢
    document.getElementById('workerCode').textContent = workerCode;
    
    // é‡æ–°è¿è¡Œ Prism é«˜äº®
    if (typeof Prism !== 'undefined') {
      Prism.highlightAll();
    }

    // å¤åˆ¶ä»£ç åŠŸèƒ½
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const btn = document.getElementById('copyBtn');
      const icon = document.getElementById('copyIcon');
      const text = document.getElementById('copyText');
      
      try {
        await navigator.clipboard.writeText(workerCode);
        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-purple-600');
        
        setTimeout(() => {
          icon.textContent = 'ğŸ“‹';
          text.textContent = 'å¤åˆ¶ä»£ç ';
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-purple-600');
        }, 2000);
      } catch (err) {
        const textarea = document.createElement('textarea');
        textarea.value = workerCode;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
      }
    });
  </script>
</body>
</html>
